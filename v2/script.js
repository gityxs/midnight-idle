var storage_marker="dv2",game_paused=0,game_speed=1,loop_inited=0,changed_tab=0,interacted=0,clicking=0,resetting=0,stab=1,changed_stab=0,buying="",last_story="";function switch_world(e){d.game.world.curr=e,changed_tab=1}function switch_tab(e=1){e>0&&(d.game.tab["curr"+d.game.world.curr]=e),changed_tab=1}function switch_stab(e=1){stab=e,changed_stab=1,gebi("gmain").innerHTML=""}function click_skill(e,l=0){if(1!=clicking){if(clicking=1,canrun=0,"a999"==e&&1==d.skill.a999.running){d.skill.a999.running=0;return}var a=d.skill[e];1==a.unlock&&0==a.running&&a.value<a.max&&(null!=a.cost?1==check_cost(e)&&(consume_cost(e),canrun=1):canrun=1),1==canrun?a.running=1:clicking=0,0==l&&(1==a.auto?a.auto=2:2==a.auto&&(a.auto=1)),clicking=0}}function update_ui(){if(1==resetting){setTimeout("update_ui()",100);return}var e=gebi("gmain"),l=d.game.world.curr,a=d.game.tab["curr"+l],i="k"+l+a;if("k15"!=i){for(var s=Object.keys(d.skill),_=0;_<s.length;_++)if(s[_].substring(0,3)==i||null!=d.game.battle&&(null!=d.skill[s[_]].attack||null!=d.skill[s[_]].enemy)){var n=d.skill[s[_]];if(1==n.unlock){var g="0"==s[_].substring(3,4)?1:0,u=null!=skill[s[_]].gold&&1==skill[s[_]].gold?1:0,o=null!=skill[s[_]].room&&1==skill[s[_]].room?1:0,k=null!=skill[s[_]].ssk&&1==skill[s[_]].ssk?1:0,c=null!=skill[s[_]].enemy&&1==skill[s[_]].enemy?1:0,b=null!=skill[s[_]].attack?1:0,p=null!=skill[s[_]].nolimit?1:0,$=null!=skill[s[_]].timer?1:0,f=null!=d.skill[s[_]].rp?1:0,x=null!=d.skill[s[_]].rm?1:0;if(1==c&&d.game.battle!=s[_])continue;if(null==gebi("gubox-"+s[_])){var y='<div id="gubox-'+s[_]+'" class="gubox noselect hand">';y+='<div id="gupanel-'+s[_]+'" class="gupanel hand" onclick="click_skill(\''+s[_]+'\');"><div id="gubgbar-'+s[_]+'" class="gubgbar clr-'+i+"d "+(1==c?"enemy":"")+" "+(1==o?"room":"")+'"></div>'+(1==c&&1==$?'<div id="guxpbgx-'+s[_]+'" class="gubar timer"><div id="guxpx-'+s[_]+'" class="guxp timer"></div></div>':"")+'<div id="guxpbg-'+s[_]+'" class="gubar '+(1==c?"enemy":"")+'"><div id="guxp-'+s[_]+'" class="guxp clr-'+i+"c "+(1==c?"enemy":"")+" "+(1==o?"room":"")+'"></div></div>'+(1==c?'<div class="guenemy"><img src="img/ico-e.png"></div>':"")+'<div class="gutitle p5 clr-'+i+'a"><b>'+skill[s[_]].title+'</b><span id="guauto-'+s[_]+'" class="guauto"></span> '+(1==g||1==b?"":' &nbsp; <div id="gulvlsmax-'+s[_]+'" class="gulvls"></div><div id="gulvls-'+s[_]+'" class="gulvls '+(1==c?"enemy":"")+'"><span id="gulvl-'+s[_]+'"></span> / <span id="gumax-'+s[_]+'"></span></div>')+(0==b?"":' &nbsp; <div id="gudice-'+s[_]+'" class="gulvls gudice"></div>')+'</div><div class="gutext p5"><span id="gutype-'+s[_]+'" class="gutype"></span> - '+skill[s[_]].text+'</div><div class="gucbar p5">'+(0==c||1==c&&1==$?'<img src="img/ico-time.png"> <span id="gutime-'+s[_]+'" class="gutime"></span> &nbsp; &nbsp;':"")+(1==c&&1==f?'<img src="img/ico-rp.png"> <span id="gurp-'+s[_]+'" class="gutime"></span> &nbsp; &nbsp;':"")+(1==c&&1==x?'<img src="img/ico-rm.png"> <span id="gurm-'+s[_]+'" class="gutime"></span> &nbsp; &nbsp;':"")+((1==g||1==o)&&0==c?'<img src="img/ico-speed.png"> <span id="guspeed-'+s[_]+'" class="gutime"></span> &nbsp; &nbsp;':"")+((1==g||1==o)&&0==c?'<img src="img/ico-add.png"> <span id="guadd-'+s[_]+'" class="gutime"></span> &nbsp; &nbsp;':"")+(0==g&&1==b&&"a999"!=s[_]?'<img src="img/ico-atk.png"> <span id="guatk-'+s[_]+'" class="gutime"></span> &nbsp; &nbsp;':"")+(0==g&&1==b&&"a999"!=s[_]?'<img src="img/ico-acc.png"> <span id="guacc-'+s[_]+'" class="gutime"></span> &nbsp; &nbsp;':"")+(0==g&&1==b&&"a999"!=s[_]?'<img src="img/ico-crit.png"> <span id="gucrit-'+s[_]+'" class="gutime"></span> &nbsp; &nbsp;':"")+'<span id="gucost-'+s[_]+'" class="gucost"></span></div></div></div>',k?gebi("gubox-"+i+"0").insertAdjacentHTML("afterend",y):u||o||c?e.innerHTML=y+e.innerHTML:e.innerHTML+=y}var L=n.value>=n.max&&0==g?1:0,T="",w=1;if(1==n.running&&(w=0),null!=n.cost&&!L&&0==c){for(var M=Object.keys(n.cost),H="",P=0;P<M.length;P++){var S=M[P].substring(0,3),E=skill[M[P]].alt,I=d.skill[M[P]].value,A=n.cost[M[P]];H+='<span class="clr-'+S+(I>=A?"a":"b")+'">'+A+" "+E+"</span> &nbsp; &nbsp;",I<A&&(w=0)}T=""+H}var B=n.curr/n.need*100+"%";if(gebi("guxp-"+s[_]).style.width=B,gebi("gubgbar-"+s[_]).style.width=B,1==$){var C=skill[s[_]].timer;d.game.tree.t41>0&&(C+=d.game.tree.t41);var D=n.curr2/C*100+"%";gebi("guxpx-"+s[_]).style.width=D,gebi("gubgbar-"+s[_]).style.width=D}if(n.auto>0&&(gebi("guauto-"+s[_]).innerHTML=1==n.auto?" (Auto)":" (Paused)"),(0==g||1==c)&&(L&&0==b?(show("gulvlsmax-"+s[_]),gebi("gulvlsmax-"+s[_]).innerHTML="MAX",hide("gulvls-"+s[_])):0==b&&(hide("gulvlsmax-"+s[_]),show("gulvls-"+s[_]),1==c?(gebi("gulvl-"+s[_]).innerHTML=n.need-n.curr,gebi("gumax-"+s[_]).innerHTML=n.need):(gebi("gulvl-"+s[_]).innerHTML=n.value,gebi("gumax-"+s[_]).innerHTML=n.max))),1==p&&(show("gulvlsmax-"+s[_]),gebi("gulvlsmax-"+s[_]).innerHTML="UNLIMITED",hide("gulvls-"+s[_])),(1==g||1==o)&&(gebi("guspeed-"+s[_]).innerHTML=stotime(n.speed)),(1==g||1==o)&&(gebi("guadd-"+s[_]).innerHTML=n.gain),1==c&&1==f&&(gebi("gurp-"+s[_]).innerHTML=n.rp),1==c&&1==x&&(gebi("gurm-"+s[_]).innerHTML=n.rm),1==b&&"a999"!=s[_]){var N=bonus_ap(s[_])+bonus_am(s[_]);gebi("guatk-"+s[_]).innerHTML=n.attack+(N>0?' <span class="bonus">(+'+N+")</span>":"")}if(1==b&&"a999"!=s[_]&&(gebi("guacc-"+s[_]).innerHTML=n.acc+d.game.tree.t34+"%"),1==b&&"a999"!=s[_]&&(gebi("gucrit-"+s[_]).innerHTML=n.crit+"x"),1!=L&&0==c&&(gebi("gutime-"+s[_]).innerHTML=stotime(n.need-n.curr)),1!=L&&1==c&&1==$){var C=skill[s[_]].timer;d.game.tree.t41>0&&(C+=d.game.tree.t41),gebi("gutime-"+s[_]).innerHTML=stotime(C)}1==L&&0==b?gebi("gubox-"+s[_]).classList.add("maxed"):gebi("gubox-"+s[_]).classList.remove("maxed"),1==u?gebi("gubox-"+s[_]).classList.add("gold"):gebi("gubox-"+s[_]).classList.remove("gold"),1==o?gebi("gubox-"+s[_]).classList.add("room"):gebi("gubox-"+s[_]).classList.remove("room"),1==c?gebi("gubox-"+s[_]).classList.add("enemy"):gebi("gubox-"+s[_]).classList.remove("enemy"),1==d.skill.k1221.value&&1==L&&0==u&&0==b&&hide("gubox-"+s[_]),""!=T&&(gebi("gucost-"+s[_]).innerHTML=T),w?gebi("gupanel-"+s[_]).classList.add("afford"+(1==o?"x":"")):(gebi("gupanel-"+s[_]).classList.remove("afford"),gebi("gupanel-"+s[_]).classList.remove("affordx"));var H="Skill";1==c&&(H=""),1==o&&(H="Adventure"),1==u&&(H="Trait"),1==b&&(H="Combat"),("k110"==s[_]||"k120"==s[_])&&(H="Resource"),"k1114"==s[_]&&(H="Expedition"),gebi("gutype-"+s[_]).innerHTML=H,null!=d.game.battle?null==n.attack&&null==n.enemy?gebi("gubox-"+s[_]).classList.add("bhide"):gebi("gubox-"+s[_]).classList.remove("bhide"):(null==n.attack&&n.enemy,gebi("gubox-"+s[_]).classList.remove("bhide"))}}}else{if(null==gebi("divspx")){var y='<div id="divspx"><br>You have <b id="balsp" class="bigger clr-'+i+'a"></b> Soul Points<br><i class="smaller">(you can only spend SP at the beginning of cycles)</i><br><br>Last cycle (#'+d.game.numcycle+') completed as <b class="clr-k15a">'+treetab[d.game.lastform]+'</b><br><i class="smaller">(cheaper buy for all '+treetab[d.game.lastform]+' traits)</i><br><br><br><span class="smaller">Available Traits</span><br></div>';e.innerHTML+=y}gebi("balsp").innerHTML=d.skill.sp.value;for(var _=1;_<=treetab.length-1;_++)if(null==gebi("stab-"+_)){var y='<div id="stab-'+_+'" class="gmenu stab smaller '+(stab==_?"stactive":"")+' p5" onclick="switch_stab('+_+')">'+treetab[_]+"</div>";e.innerHTML+=y}if(stab>0)for(var _=1;_<=9;_++){var R="t"+stab+_;if(null!=tree[R]){var X=get_stabcost(R);if(null==gebi("ttbox-"+R)){var y='<div id="ttbox-'+R+'" class="gubox noselect hand"><div id="ttpanel-'+R+'" class="gupanel p10" onclick="trybuy(\''+(can_sp(X),R)+'\');"><div class="gutitle ttt p5">'+tree[R].title+' <div id="ttlvl-'+R+'" class="ttlvl"></div></div><div class="gutext p5">'+tree[R].text+'</div><div class="gucbar p5"><span id="ttcost-'+R+'" class="gutime tttcost"></span></div><div id="ttbuy-'+R+'" style="display:none;" class="ttbuy hand" '+(can_sp(X),"onclick=\"performbuy('"+R+"'); event.stopPropagation();\"")+"><br><br><b>Confirm Buy</div></div></div>";e.innerHTML+=y}var Y='<span class="smaller">(MAXED)</span> &nbsp;',L=d.game.tree[R]<tree[R].max?0:1;"t57"==R&&1==L&&(Y='<span id="spnblocker" class="smaller" style="color:#99f" onclick="off_blocker(); event.stopPropagation(); gebi(\'ttlvl-'+R+"').innerHTML='';\">(ENABLED)</span>"),("t18"==R||"t19"==R||"t29"==R||"t36"==R||"t39"==R||"t37"==R)&&1==L&&(Y='<span id="spnam1" class="smaller" style="color:#99f" onclick="off_am(\''+R+"'); event.stopPropagation(); gebi('ttlvl-"+R+"').innerHTML='';\">(ENABLED)</span>");var O=" &nbsp; "+(0==L?"":Y)+" "+(null!=d.game.tree[R]?d.game.tree[R]:"NAN")+" / "+tree[R].max;null!=gebi("ttlvl-"+R)&&""==gebi("ttlvl-"+R).innerHTML&&(gebi("ttlvl-"+R).innerHTML=O),null!=gebi("ttcost-"+R)&&(gebi("ttcost-"+R).innerHTML=1==L?"":X+" Soul Point(s)"),null!=gebi("ttpanel-"+R)&&(can_sp(X)&&d.game.tree[R]<tree[R].max?gebi("ttpanel-"+R).classList.add("afford"):gebi("ttpanel-"+R).classList.remove("afford"))}}if(null==gebi("newcycle")&&0==d.skill.k110.unlock){var y='<br><br><input id="newcycle" type="button" class="gbtn" style="background-color:darkgreen; padding:20px;" value="开始旅途" onclick="apply_tree();" hide(\'gnoverlay\');">';e.innerHTML+=y}d.game.ginfo_open=1}setTimeout("update_ui()",15)}function update_ui_delay(){if(1==resetting){setTimeout("update_ui_delay()",100);return}"none"!=gebi("gmisc2").style.display&&(gebi("tick").innerHTML=stotime(round(d.game.tick/100)),gebi("stage").innerHTML=d.game.stage),(null!=d.skill.sp.max||d.skill.sp.value>0||1==d.game.tab.open15)&&(gebi("divcycle").style.display="block"),1==d.game.ginfo_open?(show("ginfo"),show("footer")):(hide("ginfo"),hide("footer")),1==d.game.gtab_open&&null==d.game.battle?show("gtab"):hide("gtab"),1==d.game.gworld_open&&null==d.game.battle?show("gworld"):hide("gworld"),null!=d.game.battle&&1!=d.game.tab["curr"+d.game.world.curr]&&switch_tab(1);for(var e=Object.keys(d.skill),l=0;l<e.length;l++)if(0!=d.skill[e[l]].unlock){var a="0"==e[l].substring(3,4)?1:0,i=e[l].substring(0,3);if(1==a){null==gebi("inf-"+e[l])&&(u='<div id="inf-'+e[l]+'" class="ginfbar"><div id="gibgbar-'+e[l]+'" class="gubgbar clr-'+i+'d"></div> <b>'+skill[e[l]].alt+'</b>: <span id="infc-'+e[l]+'" class="infc"></span></div>',gebi("ginfo").innerHTML+=u);var s=d.skill[e[l]].value/d.skill[e[l]].max*100+"%";gebi("gibgbar-"+e[l]).style.width=s,gebi("infc-"+e[l]).innerHTML=round2(d.skill[e[l]].value)+" / "+round(d.skill[e[l]].max)}}if(0!=d.skill.xp.need){null==gebi("inf-xp")&&(u='<div id="inf-xp" class="ginfbar"><div id="gibgbar-xp" class="gubgbar clr-xp"></div> <b><span id="infc-lvl" class="infc"></span> Exp.</b>: <span id="infc-xp" class="infc"></span></div>',gebi("ginfo").innerHTML+=u);var s=d.skill.xp.curr/d.skill.xp.need*100+"%";gebi("gibgbar-xp").style.width=s,gebi("infc-xp").innerHTML=round2(d.skill.xp.curr)+" / "+round(d.skill.xp.need),gebi("infc-lvl").innerHTML="Lvl "+d.game.player.lvl+" - "}if(1==changed_tab){gebi("gmain").innerHTML="",changed_tab=0;var _=gebi("gtab");_.innerHTML="";var n=d.game.world.curr,g=d.game.tab["curr"+n];for(l=1;l<=5;l++)if(1==d.game.tab["open"+n+l]){var u='<div id="gtab'+n+l+'" class="gmenu p5 '+(l==g?"active clr-k"+n+g+"d":"")+'" onclick="switch_tab('+l+');"><img src="img/ico-'+n+l+'.png"></div>';_.innerHTML+=u}gebi("gmain").innerHTML=""}setTimeout("update_ui_delay()",100)}function gameloop(){if(1==resetting){setTimeout("gameloop()",100),resetting=0;return}if(1==d.game.paused){setTimeout("gameloop()",10);return}progress(),clicking=0,d.game.tick++,d.game.tick%(100*save_interval)==0&&savegame(),setTimeout("gameloop()",10)}function progress(){progress_check();for(var e=0,l=Object.keys(d.skill),a=0;a<l.length;a++)if(0!=(r=d.skill[l[a]]).unlock){var i="0"==l[a].substring(3,4)?1:0;1==r.auto&&0==r.running&&r.value<r.max&&click_skill(l[a],1),1==r.running&&(2!=r.auto&&(r.curr+=r.speed/100*game_speed),r.curr>=r.need&&(r.curr=r.need,r.running=0,r.value<r.max&&(r.value+=r.gain,r.value=round2(r.value),r.value>r.max&&(r.value=r.max),r.curr=0,e=1,0==i&&up_skill(l[a]))))}if(null!=d.game.battle&&null!=skill[d.game.battle].timer){var s=d.skill[d.game.battle],_=skill[d.game.battle].timer;d.game.tree.t41>0&&(_+=d.game.tree.t41),s.curr2<_&&(s.curr2+=.01,s.curr2>=_&&(s.curr2=0,up_skill("a998")))}stage_check()}function apply_tree(){if(d.game.tree.t11>0&&(d.skill.k120.speed+=.2*d.game.tree.t11),d.game.tree.t12>0)for(var e=Object.keys(d.skill),l=0;l<e.length;l++)"e"==e[l].substr(0,1)&&(null!=d.skill[e[l]].rm&&(d.skill[e[l]].rm-=.5*d.game.tree.t12),d.skill[e[l]].rm<0&&(d.skill[e[l]].rm=0));if(d.game.tree.t13>0)for(var e=Object.keys(d.skill),l=0;l<e.length;l++)"a"==e[l].substr(0,1)&&null!=d.skill[e[l]].am&&(d.skill[e[l]].attack+=.25*d.game.tree.t13);if(d.game.tree.t14>0&&(d.skill.a114.cost.k120-=1*d.game.tree.t14,d.skill.a119.cost.k120-=1*d.game.tree.t14),d.game.tree.t15>0&&(d.skill.a114.crit+=.5*d.game.tree.t15,d.skill.a119.crit+=.5*d.game.tree.t15),d.game.tree.t16>0&&(d.skill.k1115.auto=1,d.skill.k1139.auto=1,d.skill.k1228.auto=1,d.skill.k1229.auto=1,d.skill.k11524.auto=1,d.skill.k1131.auto=1),d.game.tree.t17>0&&(d.skill.k120.gain+=d.game.tree.t17),d.game.tree.t18>0&&(d.skill.k115271.max-=d.game.tree.t18,d.skill.k115271.max<1&&(d.skill.k115271.max=1),d.skill.k114134.max-=d.game.tree.t18,d.skill.k114134.max<1&&(d.skill.k114134.max=1),d.skill.k11715.max-=d.game.tree.t18,d.skill.k11715.max<1&&(d.skill.k11715.max=1)),d.game.tree.t19>0&&(d.skill.k116.auto=1),d.game.tree.t21>0&&(d.skill.k110.speed+=.2*d.game.tree.t21),d.game.tree.t22>0)for(var e=Object.keys(d.skill),l=0;l<e.length;l++)"e"==e[l].substr(0,1)&&(null!=d.skill[e[l]].rp&&(d.skill[e[l]].rp-=.5*d.game.tree.t22),d.skill[e[l]].rp<0&&(d.skill[e[l]].rp=0));if(d.game.tree.t23>0)for(var e=Object.keys(d.skill),l=0;l<e.length;l++)"a"==e[l].substr(0,1)&&null!=d.skill[e[l]].ap&&(d.skill[e[l]].attack+=.5*d.game.tree.t23);if(d.game.tree.t24,d.game.tree.t25,d.game.tree.t26>0&&(d.skill.a111.auto=1,d.skill.a112.auto=1),d.game.tree.t27>0&&(d.skill.k110.gain+=d.game.tree.t27),d.game.tree.t28>0&&(d.skill.k1134.max=1,d.skill.k1134.auto=1,d.skill.k1134.need=.2,d.skill.k1134.cost=null,d.skill.k11510.max=1,d.skill.k11510.auto=1,d.skill.k11510.need=.2,d.skill.k11510.cost=null,d.skill.k11729.auto=1,d.skill.e1124.need=1),d.game.tree.t29>0&&(d.skill.k117.auto=1),d.game.tree.t31>0&&(d.skill.k1114.speed+=.25*d.game.tree.t31),d.game.tree.t32,d.game.tree.t33>0&&(d.skill.a113.attack+=.25*d.game.tree.t33,d.skill.a116.attack+=.25*d.game.tree.t33),d.game.tree.t34,d.game.tree.t35,d.game.tree.t36>0&&(d.skill.k1135.auto=1,d.skill.k1140.auto=1,d.skill.k11410.auto=1,d.skill.k11411.auto=1,d.skill.k115271.auto=1,d.skill.k115272.auto=1,d.skill.k11715.auto=1,d.skill.k11716.auto=1,d.skill.k11718.auto=1),d.game.tree.t37>0&&(d.skill.k11413.auto=1,d.skill.k114131.auto=1,d.skill.k11420.auto=1,d.skill.k11513.auto=1,d.skill.k11636.auto=1,d.skill.k11611.auto=1,d.skill.k11623.auto=1,d.skill.k11712.auto=1,d.skill.k11714.auto=1,d.skill.k11725.auto=1,d.skill.k114132.auto=1,d.skill.k11639.auto=1,d.skill.k11641.auto=1,d.skill.k11717.auto=1,d.skill.k11727.auto=1,d.skill.k11728.auto=1,d.skill.k11735.auto=1,d.skill.k11738.auto=1,d.skill.k11739.auto=1,d.skill.k1192.auto=1),d.game.tree.t39>0&&(d.skill.k1136.auto=1),d.game.tree.t41,d.game.tree.t42,d.game.tree.t43,d.game.tree.t44>0&&(d.skill.e113.xp+=d.game.tree.t44,d.skill.e1114.xp+=d.game.tree.t44,d.skill.e1121.xp+=d.game.tree.t44),d.game.tree.t45>0&&(d.skill.k11401.max+=10*d.game.tree.t45,d.skill.k11600.max+=10*d.game.tree.t45,d.skill.k11718.max+=10*d.game.tree.t45),d.game.tree.t46>0){for(var e=Object.keys(d.skill),l=0;l<e.length;l++)if("k"==e[l].substr(0,1)){if(null==skill[e[l]])continue;if(skill[e[l]].hasOwnProperty("room")&&1==skill[e[l]].room&&"k1114"!=e[l]){d.skill[e[l]].need-=d.game.tree.t46;var a=d.game.tree.t49>0?.1:.2;d.skill[e[l]].need<a&&(d.skill[e[l]].need=a)}}}if(d.game.tree.t47>0){for(var e=Object.keys(d.skill),l=0;l<e.length;l++)if("k"==e[l].substr(0,1)){if(null==skill[e[l]])continue;if(!skill[e[l]].hasOwnProperty("room")&&"k110"!=e[l]&&"k120"!=e[l]){d.skill[e[l]].need-=d.game.tree.t47;var a=d.game.tree.t49>0?.1:.2;d.skill[e[l]].need<a&&(d.skill[e[l]].need=a)}}}d.game.tree.t51>0&&(d.skill.k110.auto=1,d.skill.k120.auto=1,d.skill.k115.value=1,d.skill.k1224.value=1),d.game.tree.t52>0&&(d.skill.k1119.auto=1,d.skill.k1138.auto=1,d.skill.k11311.auto=1,d.skill.k11381.auto=1),d.game.tree.t53>0&&(d.skill.k114011.auto=1,d.skill.k116001.auto=1,d.skill.k117181.auto=1),d.game.tree.t54,d.game.tree.t55,d.game.tree.t56,d.game.tree.t57>0&&(tree.t57.cost=0),d.game.tree.t58>0&&(d.skill.k118.auto=1,d.skill.k119.auto=1,d.skill.k1110.auto=1,d.skill.k1111.auto=1,d.skill.k1112.auto=1,d.skill.k1113.auto=1,d.skill.k111.auto=1,d.skill.k112.auto=1,d.skill.k113.auto=1,d.skill.k114.auto=1,d.skill.k115.auto=1,d.skill.k121.auto=1,d.skill.k122.auto=1,d.skill.k123.auto=1,d.skill.k1230.auto=1,d.skill.k1121.auto=1,d.skill.k1122.auto=1,d.skill.k1123.auto=1,d.skill.k1124.auto=1,d.skill.k1125.auto=1,d.skill.k1126.auto=1,d.skill.k1221.auto=1,d.skill.k1222.auto=1,d.skill.k1223.auto=1,d.skill.k1224.auto=1,d.skill.k1225.auto=1,d.skill.k1226.auto=1,d.skill.k1116.auto=1,d.skill.k1117.auto=1,d.skill.k1118.auto=1,d.skill.k1231.auto=1,d.skill.k1232.auto=1,d.skill.k1233.auto=1,d.skill.k11211.auto=1,d.skill.k11221.auto=1,d.skill.k11231.auto=1,d.skill.k11241.auto=1,d.skill.k11261.auto=1,d.skill.k11601.auto=1,d.skill.k12221.auto=1,d.skill.k12231.auto=1,d.skill.k12261.auto=1,d.skill.k12271.auto=1,d.skill.k12281.auto=1,d.skill.k11161.auto=1,d.skill.k11171.auto=1,d.skill.k11181.auto=1,d.skill.k11191.auto=1),d.game.tree.t59>0&&(d.skill.k11520.auto=1,d.skill.k115221.auto=1,d.skill.k115222.auto=1,d.skill.k115223.auto=1,d.skill.k115231.auto=1,d.skill.k115232.auto=1,d.skill.k115233.auto=1,d.skill.k11525.auto=1,d.skill.k11526.auto=1),d.skill.k110.unlock=1,d.game.ginfo_open=1,d.game.gtab_open=1,d.game.tab.open11=1,d.game.stage=0,switch_tab(),cleartabs()}function show_tree(){d.game.gtab_open=1,d.game.tab.open15=1,d.game.world.curr=1,switch_tab(5),cleartabs(),switch_stab(d.game.lastform),d.game.paused=0,savegame()}function cycle_plane(){var e=d.game.numcycle;e++;var l=d.game.wp,a=d.game.tree,i=d.skill.sp.value,s=d.skill.sp.max,_=d.game.lastform;d=null,resetgame(),d.game.numcycle=e,d.game.wp=l,d.game.pause=1,d.skill.k110.unlock=0,d.game.gtab_open=0,d.game.ginfo_open=0,d.game.tree=a,d.skill.sp.value=i,d.skill.sp.max=s,d.game.lastform=_,cleartabs(),show_tree()}function lose_plane(e=0){var l=d.game.player.lvl+1;null==d.skill.sp.max&&(d.skill.sp.max=1e4),spo=0,spn=1,d.game.tree.t55>0&&(l+=spo=d.game.tree.t55),d.game.numcycle>0&&(l+=spn=d.game.numcycle),add_sp(l),story.n996.text='You have gained <b class="clr-k15a">'+l+' Soul Points (SP)</b><br><i class="smaller">+1 Base Reward<br>+'+d.game.player.lvl+" Level(s)<br>+"+spn+" Cycles(s)<br>+"+spo+" Soul Sponge</i><br><br>While everything else in the game resets, SP serves as a persistent currency used to upgrade your abilities in the <b>Skill Tree</b>. These enhancements carry over across plane cycles, empowering you to grow stronger and progress further each cycle.",show_notice(story.n996,64,1),cycle_plane()}function win_plane(){d.game.wp++,lose_plane(1)}function win_fight(e){d.skill.a999.running=0,d.skill.a999.curr=0;var l=d.skill[e].xp;d.game.tree.t43>0&&("e113"==e||"e1114"==e||"e1121"==e)&&(l+=d.game.tree.t44),add_xp(l),d.game.tree.t42>0&&("e113"==e&&(d.skill.k110.max+=.5*d.game.tree.t42),"e1114"==e&&(d.skill.k120.max+=.5*d.game.tree.t42)),story.n997.text="You have gained "+d.skill[e].xp+" XP.",show_notice(story.n997),d.game.battle=null,lskill(e),d.skill[e].value=0,gebi("gmain").innerHTML=""}function save_lastform(){1==d.skill.k116.unlock&&(d.game.lastform=1),1==d.skill.k117.unlock&&(d.game.lastform=2),1==d.skill.k1136.unlock&&(d.game.lastform=3),1==d.skill.k11616.unlock&&(d.game.lastform=4)}function add_xp(e){for(d.game.tree.t54>0&&(e+=d.game.tree.t54),d.skill.xp.curr+=e;d.skill.xp.curr>=d.skill.xp.need;)d.skill.xp.curr-=d.skill.xp.need,d.game.player.lvl++,d.game.player.nxp+=50,d.skill.xp.need=d.game.player.nxp}function minus_xp(e){d.skill.xp.curr-=e,d.skill.xp.curr<0&&(d.skill.xp.curr=0)}function add_sp(e){d.skill.sp.value+=e,d.skill.sp.value>d.skill.sp.max&&(d.skill.sp.value=d.skill.sp.max)}function can_sp(e){return d.game.stage<62?0:d.skill.sp.value>=e?1:0}function use_sp(e){d.skill.sp.value-=e,d.skill.sp.value<0&&(d.skill.sp.value=0)}function bonus_ap(e){var l=0;return 1==d.skill.k115221.value&&null!=d.skill[e].ap&&(l+=1),1==d.skill.k115222.value&&null!=d.skill[e].ap&&(l+=1),1==d.skill.k115223.value&&null!=d.skill[e].ap&&(l+=1),l}function bonus_am(e){var l=0;return 1==d.skill.k115231.value&&null!=d.skill[e].am&&(l+=1),1==d.skill.k115232.value&&null!=d.skill[e].am&&(l+=1),1==d.skill.k115233.value&&null!=d.skill[e].am&&(l+=1),l}function bonus_cr(){var e=0;return 1==d.skill.k11526.unlock&&(e+=10),d.game.tree.t32>0&&(e+=d.game.tree.t32),e}function attack(e){if(null!=d.game.battle){var l=d.skill[d.game.battle];(r=d.skill[e]).value=0,0==l.running&&(l.running=1);var a=Math.floor(100*Math.random())+1,i='<img src="img/ico-dice.png"> '+(100-a)+"% &nbsp; ";if(a<=r.acc+d.game.tree.t34){var s=d.skill[e].attack;s+=bonus_ap(e),s+=bonus_am(e);var _=5+bonus_cr();a<=_&&(s*=d.skill[e].crit);var n=0;null!=l.rp&&null!=d.skill[e].ap&&((s-=l.rp)<0&&(s=0),n=d.skill[d.game.battle].rp),null!=l.rm&&null!=d.skill[e].am&&((s-=l.rm)<0&&(s=0),n=d.skill[d.game.battle].rm),l.curr+=s,checkmax_c(d.game.battle),i+=(a<=_?"CRITICAL":"HIT")+' <b class="bigger red">'+s+"</b> "+(n>0?" (RESISTED "+n+")":""),null!=gebi("gudice-"+e)&&gebi("gudice-"+e).classList.remove("atkmiss")}else i+="MISS",null!=gebi("gudice-"+e)&&gebi("gudice-"+e).classList.add("atkmiss");null!=gebi("gudice-"+e)&&(gebi("gudice-"+e).innerHTML=i,setTimeout("clear('gudice-"+e+"')",700)),d.skill[d.game.battle].curr>=d.skill[d.game.battle].need&&click_skill(d.game.battle)}}function check_cost(e){var l=d.skill[e];if(null==l.cost)return 1;for(var a=Object.keys(l.cost),i=0;i<a.length;i++)if(d.skill[a[i]].value<d.skill[e].cost[a[i]])return 0;return 1}function consume_cost(e){for(var l=Object.keys(d.skill[e].cost),a=0;a<l.length;a++){var i=d.skill[l[a]];i.value-=d.skill[e].cost[l[a]]}}function trybuy(e=""){if(!(d.game.stage<62)){if(buying!=e&&hide("ttbuy-"+buying),""!=e){var l=get_stabcost(e);d.game.tree[e]<tree[e].max&&can_sp(l)?show("ttbuy-"+(buying=e)):hide("ttbuy-"+buying)}}}function performbuy(e){if(!(d.game.stage<62)){var l=get_stabcost(e);can_sp(l)&&(use_sp(l),up_stab(e)),hide("ttbuy-"+e),gebi("ttlvl-"+e).innerHTML=""}}function get_stabcost(e){return null==tree[e]?0:(tree[e].cost+tree[e].cost*d.game.tree[e])*(stab==d.game.lastform||5==stab?1:2)}function up_stab(e){!(d.game.stage<62)&&(d.game.tree[e]++,d.game.tree[e]>tree[e].max&&(d.game.tree[e]=tree[e].max),"t19"==e&&d.game.tree.t29>0&&(d.game.tree.t29=0,tree.t29.cost=0),"t29"==e&&d.game.tree.t19>0&&(d.game.tree.t19=0,tree.t19.cost=0))}function off_blocker(){1==d.game.tree.t57&&(d.game.tree.t57=0,tree.t57.cost=0)}function off_am(e){d.game.tree[e]>=1&&(d.game.tree[e]=0,tree[e].cost=0)}function round(e){return Math.round(e)}function round1(e){return Math.round(10*e)/10}function round2(e){return Math.round(100*e)/100}function stotime(e){return t="",e>3600&&(h=Math.floor(e/3600),e-=3600*h,t+=h+"h "),e>60&&(m=Math.floor(e/60),e-=60*m,t+=m+"m "),t+=round1(e).toFixed(1)+"s"}function gebi(e){return document.getElementById(e)}function show(e){null!=gebi(e)&&""!=gebi(e).style.display&&(gebi(e).style.display="")}function hide(e){null!=gebi(e)&&"none"!=gebi(e).style.display&&(gebi(e).style.display="none")}function clear(e){null!=gebi(e)&&(gebi(e).innerHTML="")}function add_story(e){var l=0;null!=d.game.story&&(l=Object.keys(d.game.story).length),d.game.story["p"+l]=e}function load_story(){for(var e="",l=Object.keys(d.game.story),a=0;a<l.length;a++)e+=story[d.game.story[l[a]]].text+"<br><br>";gebi("gnstory").innerHTML=e}function show_notice(e,l=0,a=0){last_story!=e&&(last_story=e,d.game.tree.t57>0&&l<61&&0==a?d.game.next_stage=l:(d.game.paused=1,d.game.next_stage=l,gebi("gnbtn").value="继续",gebi("gntitle").innerHTML=e.title,gebi("gntext").innerHTML=e.text,gebi("visual").src=null==e.img?"":"img/"+e.img,show("gnoverlay"),show("gnotice"),window.scrollTo(0,0)))}function close_notice(){0!=d.game.next_stage&&stage_check(),d.game.paused=0,hide("gnotice"),hide("gnoverlay"),window.scrollTo(0,0)}function cleartabs(){gebi("ginfo").innerHTML="",gebi("gtab").innerHTML="",gebi("gmain").innerHTML="",changed_tab=1}function resetgame(){resetting=1,d=null,localStorage.setItem(storage_marker,null),loadgame();for(var e=Object.keys(d.skill),l=0;l<e.length;l++)d.skill[e[l]].value=0;cleartabs()}function resetcycle(){var e=d.game.numcycle,l=d.game.wp,a=d.game.tree,i=d.skill.sp.value,s=d.skill.sp.max,_=d.game.lastform;d=null,resetgame(),d.game.numcycle=e,d.game.wp=l,d.game.tree=a,d.skill.sp.value=i,d.skill.sp.max=s,d.game.lastform=_,d.game.tab.open15=1,apply_tree(),hide("gmisc2"),hide("gnoverlay")}function exportgame(){savegame();var e=JSON.parse(localStorage.getItem(storage_marker));!0==gebi("exptxt").checked?(show("txta"),gebi("txta").innerHTML=JSON.stringify(e)):(navigator.clipboard.writeText(JSON.stringify(e)),gebi("imexinfo").innerHTML="Exported to clipboard.")}function importgame(e){var l=null;if(!0==gebi("impclip").checked)null==e?getclip():l=e;else var l=prompt("Paste your game data:");null!=l&&""!=l&&(localStorage.setItem(storage_marker,l),loadgame(),hide("gmisc2"),hide("gnoverlay"))}function getclip(){navigator.clipboard.readText().then(e=>{importgame(z=e)}).catch(e=>{})}function savegame(){localStorage.setItem(storage_marker,JSON.stringify(d))}function loadgame(){var e=JSON.parse(localStorage.getItem(storage_marker));null==e?init_d():(d=e,init_s(),init_k()),cleartabs()}function startgame(){loadgame(),switch_tab(d.game.tab["curr"+d.game.world.curr]),0==loop_inited&&(loop_inited=1,gameloop(),update_ui(),update_ui_delay())}function init_s(){for(var e=init_d(1),l=Object.keys(e.skill),a=0;a<l.length;a++)null==d.skill[l[a]]&&(d.skill[l[a]]=e.skill[l[a]])}function init_k(){for(var e=1;e<=5;e++)for(var l=1;l<=9;l++)null==d.game.tree["t"+e+l]&&(d.game.tree["t"+e+l]=0);null==d.game.wp&&(d.game.wp=0),null==d.game.numcycle&&(d.game.numcycle=0)}var bgm=null;function first_tap(){1!=interacted&&(interacted=1,(bgm=new Audio("sound/bgm.mp3")).loop=!0,bgm.addEventListener("ended",function(){this.currentTime=0,this.play()},!1),gebi("svolume").value=d.game.volume,toggle_volume(d.game.muted),do_volume(d.game.volume),0==d.game.muted&&bgm.play())}function do_volume(e){bgm.volume=e/100,d.game.volume=e}function toggle_volume(e=-1){e>-1?d.game.muted=e:d.game.muted=1==d.game.muted?0:1,1==(v=d.game.muted)?(bgm.pause(),gebi("imute").src="img/ico-v0.png"):(1==interacted&&bgm.play(),gebi("imute").src="img/ico-v1.png")}
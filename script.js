var cloud_url="https://yatseng.com/midnight-idle/misave/",storage_marker="dv2",game_speed=1,nosplash=0,loop_inited=0,changed_tab=0,interacted=0,clicking=0,resetting=0,stab=1,changed_stab=0,buying="",last_story="",last_room="",defeating=0,anctrack=0,losing=0,lastclog="",cstat=[];cstat[0]=[],cstat[1]=[];var animskele=0,skipad=0,seenportal=0,dsrate=1,keyh={32:" ",66:"b",67:"c",77:"m",81:"q",87:"w",69:"e",82:"r",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",48:"0",75:"k",76:"l",83:"s",65:"a",68:"d"},qwer=[0,81,87,0,0,69,82];function switch_world(e){d.game.world.curr=e,changed_tab=1}function switch_tab(e=1){e>0&&(d.game.tab["curr"+d.game.world.curr]=e),changed_tab=1,5==e&&stab>5&&switch_stab(5),6==e&&stab<6&&switch_stab(10)}function switch_stab(e=1){stab=e,changed_stab=1,dsrate=1,cleargm()}function click_skill(e,a=0){if(1!=clicking){if(clicking=1,canrun=0,"a999"==e&&1==d.skill.a999.running){d.skill.a999.running=0;return}var l=d.skill[e];1==l.unlock&&0==l.running&&l.value<l.max&&(null!=l.cost?1==check_cost(e)?(consume_cost(e),canrun=1):skill[e].drain&&lose_byspirit():canrun=1),1==canrun?l.running=1:clicking=0,0!=a||(1==l.auto?skill[e].drain||skill[e].eattack||(l.auto=2):2!=l.auto||(l.auto=1)),clicking=0}}function update_ui(){if(1==resetting){setTimeout("update_ui()",100);return}var e=gebi("gmain"),a=d.game.world.curr,l=d.game.tab["curr"+a],s="k"+a+l;if("k15"!=s&&"k16"!=s){for(var i=1;i<=6;i++)for(var n=Object.keys(d.skill),_=0;_<n.length;_++)if(n[_].substring(0,3)==s||null!=d.game.battle&&(null!=d.skill[n[_]].attack||null!=d.skill[n[_]].enemy)){var g=d.skill[n[_]];if(1==g.unlock){var u="0"==n[_].substring(3,4)?1:0,o=null!=skill[n[_]].gold&&1==skill[n[_]].gold?1:0,c=null!=skill[n[_]].room&&1==skill[n[_]].room?1:0,k=null!=skill[n[_]].ssk&&1==skill[n[_]].ssk?1:0,p=null!=skill[n[_]].enemy&&1==skill[n[_]].enemy?1:0,b=null!=skill[n[_]].attack?1:0,f=null!=skill[n[_]].eattack?1:0,x=null!=skill[n[_]].drain?1:0,y=null!=skill[n[_]].nolimit?1:0,w=null!=skill[n[_]].timer?1:0,L=null!=d.skill[n[_]].rp?1:0,T=null!=d.skill[n[_]].rm?1:0;if(5==i&&0==f||4==i&&0==k||3==i&&0==u||2==i&&0==c||1==i&&0==o||1==p&&d.game.battle!=n[_])continue;if(null==gebi("gubox-"+n[_])){var M='<div id="gubox-'+n[_]+'" class="gubox noselect hand gu'+s+'">';M+='<div id="gupanel-'+n[_]+'" class="gupanel hand" onclick="click_skill(\''+n[_]+'\');"><div id="gubgbar-'+n[_]+'" class="gubgbar clr-'+(1==f?"eatk":s)+"d "+(1==p?"enemy":"")+" "+(1==c?"room":"")+" "+(1==x?"drain":"")+'"></div>'+(1==p&&1==w?'<div id="guxpbgx-'+n[_]+'" class="gubar timer"><div id="guxpx-'+n[_]+'" class="guxp timer"></div></div>':"")+'<div id="guxpbg-'+n[_]+'" class="gubar '+(1==p?"enemy":"")+'"><div id="guxp-'+n[_]+'" class="guxp clr-'+(1==f?"eatk":s)+"c "+(1==p?"enemy":"")+" "+(1==c?"room":"")+" "+(1==x?"drain":"")+'"></div></div>'+(1==p?'<div class="guenemy"><img src="img/ico-e.png"></div>':"")+'<div class="gutitle '+(1==x?"drain":"")+" p7 clr-"+s+'a"><b>'+skill[n[_]].title+'</b><span id="guauto-'+n[_]+'" class="guauto"></span> '+(1==u||1==b||1==f?"":' &nbsp; <div id="gulvlsmax-'+n[_]+'" class="gulvls"></div><div id="gulvls-'+n[_]+'" class="gulvls '+(1==p?"enemy":"")+'"><span id="gulvl-'+n[_]+'"></span> / <span id="gumax-'+n[_]+'"></span></div>')+(0==b&&0==f?"":' &nbsp; <div id="gudice-'+n[_]+'" class="gulvls gudice"></div>')+'</div><div class="gutext p7"><span id="gutype-'+n[_]+'" class="gutype"></span> - <span id="gutext-'+n[_]+'">'+skill[n[_]].text+'</span></div><div class="gucbar p7">'+(0==p||1==p&&1==w?'<img src="img/ico-time.png"> <span id="gutime-'+n[_]+'" class="gutime"></span> &nbsp; &nbsp;':"")+(1==p&&1==L?'<img src="img/ico-rp.png"> <span id="gurp-'+n[_]+'" class="gutime"></span> &nbsp; &nbsp;':"")+(1==p&&1==T?'<img src="img/ico-rm.png"> <span id="gurm-'+n[_]+'" class="gutime"></span> &nbsp; &nbsp;':"")+((1==u||1==c)&&0==p?'<img src="img/ico-speed.png"> <span id="guspeed-'+n[_]+'" class="gutime"></span> &nbsp; &nbsp;':"")+((1==u||1==c)&&0==p?'<img src="img/ico-add.png"> <span id="guadd-'+n[_]+'" class="gutime"></span> &nbsp; &nbsp;':"")+(0==u&&(1==b||1==f)&&"a999"!=n[_]?'<img src="img/ico-atk.png"> <span id="guatk-'+n[_]+'" class="gutime"></span> &nbsp; &nbsp;':"")+(0==u&&1==b&&"a999"!=n[_]?'<img src="img/ico-acc.png"> <span id="guacc-'+n[_]+'" class="gutime"></span> &nbsp; &nbsp;':"")+(0==u&&1==b&&"a999"!=n[_]?'<img src="img/ico-crit.png"> <span id="gucrit-'+n[_]+'" class="gutime"></span> &nbsp; &nbsp;':"")+'<span id="gucost-'+n[_]+'" class="gucost"></span><span id="gumem-'+n[_]+'" class="gumem"></span></div></div></div>',k?gebi("gubox-"+s+"0").insertAdjacentHTML("afterend",M):o||c||p||f?e.innerHTML=M+e.innerHTML:e.innerHTML+=M}var H=g.value>=g.max&&0==u?1:0,S="",E=1;if(1==g.running&&(E=0),null!=g.cost&&!H&&0==p){for(var A=Object.keys(g.cost),C="",P=0;P<A.length;P++){var I=A[P].substring(0,3),D=skill[A[P]].alt,B=d.skill[A[P]].value,N=g.cost[A[P]];C+='<span class="clr-'+I+(B>=N?"a":"b")+'">'+N+" "+D+"</span> &nbsp; &nbsp;",B<N&&(E=0)}S=""+C}var O=g.curr/g.need*100+"%";if(gebi("guxp-"+n[_]).style.width=O,gebi("gubgbar-"+n[_]).style.width=O,1==w){var j=skill[n[_]].timer;d.game.tree.t41>0&&(j+=d.game.tree.t41);var Y=g.curr2/j*100+"%";gebi("guxpx-"+n[_]).style.width=Y,gebi("gubgbar-"+n[_]).style.width=Y}if(g.auto>0){var C=1==g.auto?" (Auto)":" (Paused)";retext("guauto-"+n[_],C)}if((0==u||1==p)&&(H&&0==b&&0==f?(show("gulvlsmax-"+n[_]),retext("gulvlsmax-"+n[_],"MAX"),hide("gulvls-"+n[_])):0==b&&0==f&&(hide("gulvlsmax-"+n[_]),show("gulvls-"+n[_]),1==p?(retext("gulvl-"+n[_],""+(g.need-g.curr)),retext("gumax-"+n[_],g.need)):(retext("gulvl-"+n[_],""+g.value),retext("gumax-"+n[_],g.max)))),1==y&&(show("gulvlsmax-"+n[_]),retext("gulvlsmax-"+n[_],"UNLIMITED"),hide("gulvls-"+n[_])),(1==u||1==c)&&retext("guspeed-"+n[_],stotime(g.speed)),(1==u||1==c)&&retext("guadd-"+n[_],g.gain),1==p&&1==L&&retext("gurp-"+n[_],g.rp),1==p&&1==T&&retext("gurm-"+n[_],g.rm),(1==b||1==f)&&"a999"!=n[_]){var R=bonus_ap(n[_])+bonus_am(n[_]);1==f&&(R=0),retext("guatk-"+n[_],g.attack+(R>0?' <span class="bonus">(+'+R+")</span>":""))}if(1==b&&"a999"!=n[_]&&retext("guacc-"+n[_],g.acc+d.game.tree.t34+"%"),1==b&&"a999"!=n[_]&&retext("gucrit-"+n[_],g.crit+"x"),1!=H&&0==p&&retext("gutime-"+n[_],stotime(g.need-g.curr)),1!=H&&1==p&&1==w){var j=skill[n[_]].timer;d.game.tree.t41>0&&(j+=d.game.tree.t41),retext("gutime-"+n[_],stotime(j-g.curr2))}1==H&&0==b&&0==f?gebi("gubox-"+n[_]).classList.add("maxed"):gebi("gubox-"+n[_]).classList.remove("maxed"),1==o?gebi("gubox-"+n[_]).classList.add("gold"):gebi("gubox-"+n[_]).classList.remove("gold"),1==c?gebi("gubox-"+n[_]).classList.add("room"):gebi("gubox-"+n[_]).classList.remove("room"),1==p?gebi("gubox-"+n[_]).classList.add("enemy"):gebi("gubox-"+n[_]).classList.remove("enemy"),1==d.skill.k1221.value&&1==H&&0==o&&0==b&&0==f&&hide("gubox-"+n[_]),""!=S&&retext("gucost-"+n[_],S),E&&0==x?gebi("gupanel-"+n[_]).classList.add("afford"+(1==c?"x":"")):(gebi("gupanel-"+n[_]).classList.remove("afford"),gebi("gupanel-"+n[_]).classList.remove("affordx")),1==x&&gebi("gupanel-"+n[_]).classList.add("drain");var C="Skill";1==p&&(C=""),1==c&&(C="Adventure"),1==o&&(C="Trait"),1==b&&(C="Combat"),1==f&&(C="Enemy Attack"),("k110"==n[_]||"k120"==n[_])&&(C="Resource"),"k1114"==n[_]&&(C="Expedition"),retext("gutype-"+n[_],C);try{null!=d.game.perm.mem.lrun&&("Trait"==C||"Adventure"==C)&&null!=d.game.perm.mem.lrun&&d.game.perm.mem.lrun.length>0&&d.game.perm.mem.lrun.includes(n[_])&&retext("gumem-"+n[_],' <img src="img/ico-mem.png"> Last Cycle')}catch(q){}null!=d.game.battle?null==g.attack&&null==g.enemy?gebi("gubox-"+n[_]).classList.add("bhide"):gebi("gubox-"+n[_]).classList.remove("bhide"):(null==g.attack&&g.enemy,gebi("gubox-"+n[_]).classList.remove("bhide"))}}}else if("k15"==s){if(null==gebi("divspx")){var M='<div id="divspx"><br>You have <b id="balsp" class="bigger clr-'+s+'a"></b> Soul Points<br><i class="smaller">(you can only spend SP at the beginning of cycles)</i><br><br>Last cycle (#'+d.game.numcycle+') completed as <b class="clr-k15a">'+treetab[d.game.lastform]+'</b><br><i class="smaller">(cheaper buy for all '+treetab[d.game.lastform]+' traits)</i><br><br><br><span class="smaller">Available Traits</span><br></div>';e.innerHTML+=M}retext("balsp",d.skill.sp.value);for(var _=1;_<=5;_++)if(null==gebi("stab-"+_)){var M='<div id="stab-'+_+'" class="gmenu stab smaller '+(stab==_?"stactive":"")+' p5" onclick="switch_stab('+_+')">'+treetab[_]+"</div>";e.innerHTML+=M}if(stab>0)for(var _=1;_<=19;_++){var G="t"+stab+_;if(null!=tree[G]){var U=get_stabcost(G);if("t311"==G&&1!=d.game.perm.e1138||"t210"==G&&1!=d.game.perm.e1139||"t110"==G&&1!=d.game.perm.e1142||"t211"==G&&1!=d.game.perm.e1144||"t510"==G&&1!=d.game.perm.hourg)continue;if(null==gebi("ttbox-"+G)){var M='<div id="ttbox-'+G+'" class="gubox noselect hand"><div id="ttpanel-'+G+'" class="gupanel p10" onclick="trybuy(\''+(can_sp(U),G)+'\');"><div class="gutitle ttt p5">'+tree[G].title+' <div id="ttlvl-'+G+'" class="ttlvl"></div></div><div id="gutextd-'+G+'" class="gutext p5">'+tree[G].text+(null!=tree[G].toggle||null!=tree[G].toggle2?' <span class="white">(can toggle)</span>':"")+'</div><div class="gucbar p5"><span id="ttcost-'+G+'" class="gutime tttcost"></span></div><div id="ttbuy-'+G+'" style="display:none;" class="ttbuy hand" '+(can_sp(U),"onclick=\"performbuy('"+G+"'); event.stopPropagation();\"")+"><br><br><b>Confirm Buy</div></div></div>";e.innerHTML+=M}var X='<span class="smaller">(MAXED)</span> &nbsp;',H=d.game.tree[G]<tree[G].max?0:1;null!=tree[G].toggle2&&1==H&&(X='<span id="spnblocker" class="smaller" style="color:#99f" onclick="off_blocker(); event.stopPropagation(); gebi(\'ttlvl-'+G+"').innerHTML='';\">(ENABLED)</span>"),null!=tree[G].toggle&&1==H&&(X='<span id="spnam1" class="smaller" style="color:#99f" onclick="off_am(\''+G+"'); event.stopPropagation(); gebi('ttlvl-"+G+"').innerHTML='';\">(ENABLED)</span>");var Q=" &nbsp; "+(0==H?"":X)+" "+(null!=d.game.tree[G]?d.game.tree[G]:"NAN")+" / "+tree[G].max;null!=gebi("ttlvl-"+G)&&""==gebi("ttlvl-"+G).innerHTML&&retext("ttlvl-"+G,Q),null!=gebi("ttcost-"+G)&&retext("ttcost-"+G,1==H?"":U+" Soul Point(s)"),null!=gebi("ttpanel-"+G)&&(can_sp(U)&&d.game.tree[G]<tree[G].max?gebi("ttpanel-"+G).classList.add("afford"):gebi("ttpanel-"+G).classList.remove("afford"))}}if(null==gebi("cabacabi")){var M='<div id="cabacabi" class="smaller" style="color:#ccc"><span class="cabi">Class Inherit: </span>Effects are inherited even if you change class.<br><span class="caba">Class Active: </span>Skill only applicable when you are in this class.<br>Click on <span style="color:#99f">(ENABLED)</span> for toggleable skills to turn them off.</div>';e.innerHTML+=M}if(null==gebi("newcycle")&&0==d.skill.k110.unlock){var M='<br><br><input id="newcycle" type="button" class="gbtn" style="background-color:darkgreen; padding:20px;" value="开始旅途" onclick="apply_tree();"><br><br><div style="font-size:80%; color:#999;">[B] to Begin</div>';e.innerHTML+=M}d.game.ginfo_open=1}else if("k16"==s){if(null==gebi("divwpx")){var M='<div id="divwpx"><br>You have <b id="balwp" class="bigger clr-'+s+'a"></b> Demon Souls<br><i class="smaller">(you can only spend DS with Orc Shaman)</i><br><br><br><span class="smaller">Available Traits</span><br></div>';e.innerHTML+=M}retext("balwp",d.game.wp);for(var _=6;_<=10;_++)if(null==gebi("stab-"+_)&&1==d.game.perm["t"+_+"open"]){var M='<div id="stab-'+_+'" class="gmenu stab smaller '+(stab==_?"wpactive":"")+' p5" onclick="switch_stab('+_+')">'+treetab[_]+"</div>";e.innerHTML+=M}if(10==stab&&null==gebi("dsmult")){var M='<div id="dsmult" class="smaller">Buy/Sell DS -  <span id="bsrate1" class="multa" onclick="togmult(1);">x1</span> &nbsp; <span id="bsrate2" class="multb" onclick="togmult(2);">x10</span> &nbsp; <span id="bsrate3" class="multb" onclick="togmult(3);">x100</span></div><br>';e.innerHTML+=M}if(stab>0)for(var _=1;_<=14;_++){var G="t"+stab+"_"+_;if(null!=tree[G]){var U=get_stabcostw(G);if("t8_5"==G&&1!=d.game.perm.e1140||"t9_1"==G&&1!=d.game.perm.e1141||"t6_4"==G&&1!=d.game.perm.e1143||"t9_2"==G&&1!=d.game.perm.e1145||"t7_10"==G&&1!=d.game.perm.e1146||"t6_10"==G&&1!=d.game.perm.e1147||"t9_7"==G&&1!=d.game.perm.e1148||"t10_9"==G&&1!=d.game.perm.kbenc||"t10_10"==G&&1!=d.game.perm.manap||"t10_11"==G&&1!=d.game.perm.sfuse||"t10_12"==G&&1!=d.game.perm.rubyp||"t10_13"==G&&1!=d.game.perm.snekc||"t10_14"==G&&1!=d.game.perm.ktrea)continue;if(null==gebi("ttbox-"+G)){var M='<div id="ttbox-'+G+'" class="gubox noselect hand"><div id="ttpanel-'+G+'" class="gupanel p10" onclick="trybuyw(\''+G+'\');"><div class="gutitle tttw p5">'+tree[G].title+' <div id="ttlvl-'+G+'" class="ttlvl"></div></div><div id="gutextd-'+G+'" class="gutext p5">'+tree[G].text+(null!=tree[G].toggle?' <span class="white">(can toggle)</span>':"")+'</div><div class="gucbar p5"><span id="ttcost-'+G+'" class="gutime tttcost'+("t10_2"==G?"":"w")+'"></span></div><div id="ttbuy-'+G+'" style="display:none;" class="ttbuy hand" onclick="performbuyw(\''+G+"'); event.stopPropagation();\"><br><br><b>Confirm Buy</div></div></div>";e.innerHTML+=M}var X='<span class="smaller">(MAXED)</span> &nbsp;';null!=tree[G].nolimit&&(X="");var H=d.game.tree[G]<tree[G].max?0:1;null!=tree[G].toggle&&1==H&&(X='<span id="spnam1" class="smaller" style="color:#99f" onclick="off_am(\''+G+"'); event.stopPropagation(); gebi('ttlvl-"+G+"').innerHTML='';\">(ENABLED)</span>");var Q=" &nbsp; "+(0==H?"":X)+" "+(null!=d.game.tree[G]?d.game.tree[G]:G+"NAN")+" / "+tree[G].max;null!=tree[G].nolimit&&(Q="UNLIMITED"),null!=gebi("ttlvl-"+G)&&""==gebi("ttlvl-"+G).innerHTML&&retext("ttlvl-"+G,Q),null!=gebi("ttcost-"+G)&&retext("ttcost-"+G,1==H?"":U+("t10_2"==G?" Soul Point(s)":" Demon Soul(s)")),null!=gebi("ttpanel-"+G)&&(("t10_2"==G?can_sp(U,1):can_ds(U))&&d.game.tree[G]<tree[G].max&&76==d.game.stage?gebi("ttpanel-"+G).classList.add("afford"):gebi("ttpanel-"+G).classList.remove("afford"))}}if(null==gebi("cabacabi")){var M='<div id="cabacabi" class="smaller" style="color:#ccc"><span class="cabi">Class Inherit: </span>Effects are inherited even if you change class.<br><span class="caba">Class Active: </span>Skill only applicable when you are in this class.<br>Click on <span style="color:#99f">(ENABLED)</span> for toggleable skills to turn them off.</div>';e.innerHTML+=M}d.game.ginfo_open=1}setTimeout("update_ui()",15)}function update_ui_delay(){if(1==resetting){setTimeout("update_ui_delay()",100);return}"none"!=gebi("gmisc2").style.display&&(retext("tick",stotime(round(d.game.tick/100)).replace(".0","")),retext("stage",d.game.stage)),(null!=d.skill.sp.max||d.skill.sp.value>0||1==d.game.tab.open15)&&(gebi("divcycle").style.display="block"),1==d.game.ginfo_open?(show("ginfo"),show("header"),show("footer")):(hide("ginfo"),hide("header"),hide("footer")),1==d.game.gtab_open&&null==d.game.battle?show("gtab"):hide("gtab"),1==d.game.gworld_open&&null==d.game.battle?show("gworld"):hide("gworld"),null!=d.game.battle&&1!=d.game.tab["curr"+d.game.world.curr]&&switch_tab(1);for(var e=Object.keys(d.skill),a=0;a<e.length;a++)if(0!=d.skill[e[a]].unlock){var l="0"==e[a].substring(3,4)?1:0,s=e[a].substring(0,3);if(1==l){null==gebi("inf-"+e[a])&&(o='<div id="inf-'+e[a]+'" class="ginfbar"><div id="gibgbar-'+e[a]+'" class="gubgbar clr-'+s+'d"></div> <b>'+skill[e[a]].alt+'</b>: <span id="infc-'+e[a]+'" class="infc"></span></div>',gebi("ginfo").innerHTML+=o);var i=d.skill[e[a]].value/d.skill[e[a]].max*100+"%";gebi("gibgbar-"+e[a]).style.width=i;var n=round2(d.skill[e[a]].value)+" / "+round(d.skill[e[a]].max);d.game.tree.t10_10>0&&"k12"==s&&(n+=" (Pendant "+(d.skill.k1242.max-d.skill.k1242.value)+" / "+d.skill.k1242.max+")"),d.game.tree.t10_12>0&&"k11"==s&&(n+=" (Pendant "+(d.skill.k1243.max-d.skill.k1243.value)+" / "+d.skill.k1243.max+")"),retext("infc-"+e[a],n)}}if(0!=d.skill.xp.need){null==gebi("inf-xp")&&(o='<div id="inf-xp" class="ginfbar"><div id="gibgbar-xp" class="gubgbar clr-xp"></div> <b><span id="infc-lvl" class="infc"></span> Exp.</b>: <span id="infc-xp" class="infc"></span></div>',gebi("ginfo").innerHTML+=o);var i=d.skill.xp.curr/d.skill.xp.need*100+"%";gebi("gibgbar-xp").style.width=i,retext("infc-xp",round2(d.skill.xp.curr)+" / "+round(d.skill.xp.need)),retext("infc-lvl","Lvl "+d.game.player.lvl+" - ")}if(d.game.stage>=73){null==gebi("inf-st")&&(o='<div id="inf-st" class="ginfbar"><div id="gibgbar-st" class="gubgbar clr-st"></div> <b>Spirit</b>: <span id="infc-st" class="infc"></span></div>',gebi("ginfo").innerHTML+=o);var i=d.skill.st.value/d.skill.st.max*100+"%";gebi("gibgbar-st").style.width=i,retext("infc-st",round2(d.skill.st.value)+" / "+round(d.skill.st.max))}if(1==changed_tab){cleargm(),changed_tab=0;var _=gebi("gtab");_.innerHTML="";var g=d.game.world.curr,u=d.game.tab["curr"+g];for(a=1;a<=6;a++)if(1==d.game.tab["open"+g+a]){var o='<div id="gtab'+g+a+'" class="gmenu p5 '+(a==u?"active clr-k"+g+u+"d":"")+'" onclick="switch_tab('+a+');"><img src="img/ico-'+g+a+'.png"><div id="tabval'+g+a+'" class="tabval"></div><div class="tabkey">'+keyh[qwer[a]].toUpperCase()+"</div></div>";_.innerHTML+=o}cleargm()}retext("tabval15",d.skill.sp.value),retext("tabval16",""+d.game.wp),retext("gspeed",game_speed),setTimeout("update_ui_delay()",100)}function gameloop(){if(1==resetting){setTimeout("gameloop()",100),resetting=0;return}if(1==d.game.paused){setTimeout("gameloop()",10);return}progress(),clicking=0,d.game.tick++,d.game.tick%(100*save_interval)==0&&savegame(),setTimeout("gameloop()",10)}function progress(){d.game.tree.t510>=0&&(game_speed=1+.01*d.game.tree.t510),progress_check();for(var e=Object.keys(d.skill),a=0;a<e.length;a++)if(0!=(r=d.skill[e[a]]).unlock){var l="0"==e[a].substring(3,4)?1:0;1==r.auto&&0==r.running&&r.value<r.max&&click_skill(e[a],1),1==r.running&&(2!=r.auto&&(r.curr+=r.speed/100*game_speed),r.curr>=r.need&&"st"!=e[a]&&(r.curr=r.need,r.running=0,r.value<r.max&&(r.value+=r.gain,r.value=round2(r.value),r.value>r.max&&(r.value=r.max),"e"==e[a].substr(0,1)&&getcstat(d.game.battle,1),r.curr=0,0==l&&up_skill(e[a]))))}if(null!=d.game.battle&&null!=skill[d.game.battle].timer){var s=d.skill[d.game.battle],i=skill[d.game.battle].timer;d.game.tree.t41>0&&(i+=d.game.tree.t41),s.curr2<i&&(s.curr2+=.01*game_speed,s.curr2>=i&&(s.curr2=0,up_skill("a998")))}stage_check()}function apply_tree(){if(d.game.tree.t11>0&&(d.skill.k120.speed+=.2*d.game.tree.t11),d.game.tree.t12>0)for(var e=Object.keys(d.skill),a=0;a<e.length;a++)"e"==e[a].substr(0,1)&&(null!=d.skill[e[a]].rm&&(d.skill[e[a]].rm-=.5*d.game.tree.t12),d.skill[e[a]].rm<0&&(d.skill[e[a]].rm=0));if(d.game.tree.t13>0)for(var e=Object.keys(d.skill),a=0;a<e.length;a++)"a"==e[a].substr(0,1)&&null!=d.skill[e[a]].am&&(d.skill[e[a]].attack+=.25*d.game.tree.t13);if(d.game.tree.t14>0&&(d.skill.a114.cost.k120-=1*d.game.tree.t14,d.skill.a119.cost.k120-=1*d.game.tree.t14),d.game.tree.t15>0&&(d.skill.a114.crit+=1*d.game.tree.t15,d.skill.a119.crit+=1*d.game.tree.t15),d.game.tree.t16>0&&(d.skill.k1115.auto=1,d.skill.k1139.auto=1,d.skill.k1228.auto=1,d.skill.k1229.auto=1,d.skill.k11524.auto=1,d.skill.k1131.auto=1),d.game.tree.t17>0&&(d.skill.k120.gain+=d.game.tree.t17),d.game.tree.t18>0&&(d.skill.k115271.max-=d.game.tree.t18,d.skill.k115271.max<1&&(d.skill.k115271.max=1),d.skill.k114134.max-=d.game.tree.t18,d.skill.k114134.max<1&&(d.skill.k114134.max=1),d.skill.k11715.max-=d.game.tree.t18,d.skill.k11715.max<1&&(d.skill.k11715.max=1)),d.game.tree.t19>0&&(d.skill.k116.auto=1),d.game.tree.t21>0&&(d.skill.k110.speed+=.2*d.game.tree.t21),d.game.tree.t22>0)for(var e=Object.keys(d.skill),a=0;a<e.length;a++)"e"==e[a].substr(0,1)&&(null!=d.skill[e[a]].rp&&(d.skill[e[a]].rp-=.5*d.game.tree.t22),d.skill[e[a]].rp<0&&(d.skill[e[a]].rp=0));if(d.game.tree.t23>0)for(var e=Object.keys(d.skill),a=0;a<e.length;a++)"a"==e[a].substr(0,1)&&null!=d.skill[e[a]].ap&&(d.skill[e[a]].attack+=.5*d.game.tree.t23);if(d.game.tree.t24,d.game.tree.t25,d.game.tree.t26>0&&(d.skill.a111.auto=1,d.skill.a111a.auto=1,d.skill.a111c.auto=1,d.skill.a112.auto=1,d.skill.a113.auto=1,d.skill.a114.auto=1,d.skill.a115.auto=1,d.skill.a116.auto=1,d.skill.a117.auto=1),d.game.tree.t27>0&&(d.skill.k110.gain+=d.game.tree.t27),d.game.tree.t28>0&&(d.skill.k1134.max=1,d.skill.k1134.auto=1,d.skill.k1134.need=.2,d.skill.k1134.cost=null,d.skill.k11510.max=1,d.skill.k11510.auto=1,d.skill.k11510.need=.2,d.skill.k11510.cost=null,d.skill.k11729.auto=1,d.skill.e1124.need=1),d.game.tree.t29>0&&(d.skill.k117.auto=1),d.game.tree.t210>0&&(d.skill.k1227.cost=null,d.skill.k1227.auto=1),d.game.tree.t211>0&&(d.skill.k110.max+=1e3*d.game.tree.t211),d.game.tree.t31>0&&(d.skill.k1114.speed+=.25*d.game.tree.t31),d.game.tree.t32,d.game.tree.t33>0&&(d.skill.a113.attack+=.25*d.game.tree.t33,d.skill.a116.attack+=.25*d.game.tree.t33),d.game.tree.t34,d.game.tree.t35,d.game.tree.t36>0&&(d.skill.k1135.auto=1,d.skill.k1140.auto=1,d.skill.k11410.auto=1,d.skill.k11411.auto=1,d.skill.k115271.auto=1,d.skill.k115272.auto=1,d.skill.k11715.auto=1,d.skill.k11716.auto=1,d.skill.k11718.auto=1,d.skill.k114133.auto=1,d.skill.k114134.auto=1,d.skill.k114131.auto=1),d.game.tree.t37>0&&(d.skill.k11413.auto=1,d.skill.k11420.auto=1,d.skill.k11513.auto=1,d.skill.k11636.auto=1,d.skill.k11611.auto=1,0==d.game.perm.klg&&(d.skill.k11623.auto=1),d.skill.k11712.auto=1,d.skill.k11714.auto=1,d.skill.k11725.auto=1,d.skill.k114132.auto=1,d.skill.k11639.auto=1,d.skill.k11641.auto=1,d.skill.k11717.auto=1,d.skill.k11727.auto=1,d.skill.k11728.auto=1,d.skill.k11735.auto=1,d.skill.k11738.auto=1,d.skill.k11739.auto=1,d.skill.k1192.auto=1),d.game.tree.t39>0&&(d.skill.k1136.auto=1),d.game.tree.t310>0&&(d.skill.k1137.auto=1),d.game.tree.t311>0&&(d.skill.a117.attack+=d.game.tree.t311),d.game.tree.t41,d.game.tree.t42,d.game.tree.t43,d.game.tree.t44>0&&(d.skill.e113.xp+=d.game.tree.t44,d.skill.e1114.xp+=d.game.tree.t44,d.skill.e1121.xp+=d.game.tree.t44),d.game.tree.t45>0&&(d.skill.k11401.max+=10*d.game.tree.t45,d.skill.k11600.max+=10*d.game.tree.t45,d.skill.k11718.max+=10*d.game.tree.t45),d.game.tree.t46>0){for(var e=Object.keys(d.skill),a=0;a<e.length;a++)if("k"==e[a].substr(0,1)){if(null==skill[e[a]])continue;if(skill[e[a]].hasOwnProperty("room")&&1==skill[e[a]].room&&"k1114"!=e[a]&&null==skill[e[a]].drain){null!=skill[e[a]].jtime&&(d.skill[e[a]].need=skill[e[a]].jtime),d.skill[e[a]].need-=d.game.tree.t46;var l=d.game.tree.t49>0?.1:.2;d.skill[e[a]].need<l&&(d.skill[e[a]].need=l)}}}if(d.game.tree.t47>0){for(var e=Object.keys(d.skill),a=0;a<e.length;a++)if("k"==e[a].substr(0,1)){if(null==skill[e[a]])continue;if(!skill[e[a]].hasOwnProperty("room")&&"k110"!=e[a]&&"k120"!=e[a]&&null==skill[e[a]].drain&&null==skill[e[a]].eattack){d.skill[e[a]].need-=d.game.tree.t47;var l=d.game.tree.t49>0?.1:.2;d.skill[e[a]].need<l&&(d.skill[e[a]].need=l)}}}d.game.tree.t51>0&&(d.skill.k110.auto=1,d.skill.k120.auto=1,d.skill.k115.value=1,d.skill.k1224.value=1),d.game.tree.t52>0&&(d.skill.k1119.auto=1,d.skill.k1138.auto=1,d.skill.k11311.auto=1,d.skill.k11381.auto=1),d.game.tree.t53>0&&(d.skill.k11401.auto=1,d.skill.k114011.auto=1,d.skill.k11600.auto=1,d.skill.k116001.auto=1,d.skill.k117181.auto=1),d.game.tree.t54,d.game.tree.t55,d.game.tree.t56,d.game.tree.t57>0&&(tree.t57.cost=0),d.game.tree.t58>0&&(d.skill.k118.auto=1,d.skill.k119.auto=1,d.skill.k1110.auto=1,d.skill.k1111.auto=1,d.skill.k1112.auto=1,d.skill.k1113.auto=1,d.skill.k111.auto=1,d.skill.k112.auto=1,d.skill.k113.auto=1,d.skill.k114.auto=1,d.skill.k115.auto=1,d.skill.k121.auto=1,d.skill.k122.auto=1,d.skill.k123.auto=1,d.skill.k1230.auto=1,d.skill.k1121.auto=1,d.skill.k1122.auto=1,d.skill.k1123.auto=1,d.skill.k1124.auto=1,d.skill.k1125.auto=1,d.skill.k1126.auto=1,d.skill.k1221.auto=1,d.skill.k1222.auto=1,d.skill.k1223.auto=1,d.skill.k1224.auto=1,d.skill.k1225.auto=1,d.skill.k1226.auto=1,d.skill.k1116.auto=1,d.skill.k1117.auto=1,d.skill.k1118.auto=1,d.skill.k1231.auto=1,d.skill.k1232.auto=1,d.skill.k1233.auto=1,d.skill.k11211.auto=1,d.skill.k11221.auto=1,d.skill.k11231.auto=1,d.skill.k11241.auto=1,d.skill.k11261.auto=1,d.skill.k11601.auto=1,d.skill.k12221.auto=1,d.skill.k12231.auto=1,d.skill.k12261.auto=1,d.skill.k12271.auto=1,d.skill.k12281.auto=1,d.skill.k11161.auto=1,d.skill.k11171.auto=1,d.skill.k11181.auto=1,d.skill.k11191.auto=1),d.game.tree.t59>0&&(d.skill.k11520.auto=1,d.skill.k115221.auto=1,d.skill.k115222.auto=1,d.skill.k115223.auto=1,d.skill.k115231.auto=1,d.skill.k115232.auto=1,d.skill.k115233.auto=1,d.skill.k11525.auto=1,d.skill.k11526.auto=1),1==d.game.perm.klg&&-1==skill.k11624.title.indexOf("New Quest Line")&&(skill.k11624.title+=" <b style='color:yellow;'>(New Quest Line)</b>"),apply_tree2(),d.skill.k110.unlock=1,d.game.ginfo_open=1,d.game.gtab_open=1,d.game.tab.open11=1,1==d.game.perm.trade&&(d.game.tab.open16=1),d.game.stage=0,d.game.story=[],interacted=0,switch_tab(),cleartabs(),d.game.paused=0}function apply_tree2(){if(d.game.tree.t6_2>0&&(d.skill.k120.need=6-.5*d.game.tree.t6_2),d.game.tree.t6_3>0&&d.game.stage<=73)for(var e=Object.keys(d.skill),a=0;a<e.length;a++)null!=skill[e[a]].isnode&&(d.skill[e[a]].need-=d.game.tree.t6_3,d.skill[e[a]].need<0&&(d.skill[e[a]].need=.1));if(d.game.tree.t6_4>0&&d.game.stage<=73&&(d.skill.a11901.attack+=d.game.tree.t6_4,d.skill.a11902.attack+=d.game.tree.t6_4,d.skill.a11903.attack+=d.game.tree.t6_4),d.game.tree.t6_8>0&&(d.skill.k1241.unlock=1),d.game.tree.t6_9>0?d.skill.k11x0046.auto=1:d.skill.k11x0046.auto=0,d.game.tree.t6_10>0&&d.game.stage>=73&&(d.skill.k1246.unlock=1),d.game.tree.t7_1>0){for(var e=Object.keys(d.skill),a=0;a<e.length;a++)if("k"==e[a].substr(0,1)){if(null==skill[e[a]])continue;if(skill[e[a]].hasOwnProperty("room")&&1==skill[e[a]].room&&"k1114"!=e[a]&&null==skill[e[a]].drain&&null!=skill[e[a]].jtime){var l=skill[e[a]].jtime;l-=d.game.tree.t46,l-=d.game.tree.t7_1;var s=d.game.tree.t49>0?.1:.2;l<s&&(l=s),d.skill[e[a]].need=l}}}d.game.tree.t7_3>0&&d.game.stage<=73&&(d.skill.k110.speed+=.3*d.game.tree.t7_3),d.game.tree.t7_4>0&&(1==skipad?(skipad=0,anctrack=0,hide("gbat")):(anctrack=1,show("gbat"))),d.game.tree.t7_6>0?d.skill.k11x0035.auto=1:d.skill.k11x0035.auto=0,d.game.tree.t7_7>0?d.skill.k11x0071.auto=1:d.skill.k11x0071.auto=0,d.game.tree.t7_8>0&&(d.skill.a111a.unlock=1),d.game.tree.t7_9>0?d.skill.k11x0047.auto=1:d.skill.k11x0047.auto=0,d.game.tree.t8_5>0&&d.game.stage<=73&&(d.skill.a11910.attack+=d.game.tree.t8_5),d.game.tree.t8_7>0?d.skill.k11x0072.auto=1:d.skill.k11x0072.auto=0,d.game.tree.t8_8>0&&(d.skill.a111c.unlock=1),d.game.tree.t8_9>0?d.skill.k11x0045.auto=1:d.skill.k11x0045.auto=0,d.game.tree.t9_6>0?d.skill.k11x0034.auto=1:d.skill.k11x0034.auto=0,d.game.tree.t9_8>0?d.skill.k11x0044.auto=1:d.skill.k11x0044.auto=0,d.game.tree.t10_8>0&&(d.skill.k11x000.auto=1),d.game.tree.t10_9>0&&(d.skill.a111b.unlock=1),d.game.tree.t10_10>0&&(d.skill.k1242.unlock=1,d.skill.k1242.max=d.game.tree.t10_10),d.game.tree.t10_11>0&&d.game.stage<=73&&(d.skill.a117.need=10-d.game.tree.t10_11),d.game.tree.t10_12>0&&(d.skill.k1243.unlock=1,d.skill.k1243.max=d.game.tree.t10_12),d.game.tree.t10_13>0&&d.game.stage<=73&&(d.skill.a114.attack+=d.game.tree.t10_13,d.skill.a115.attack+=d.game.tree.t10_13)}function show_tree(){d.game.gtab_open=1,d.game.tab.open15=1,1==d.game.perm.trade&&(d.game.tab.open16=1),d.game.world.curr=1,switch_tab(5),cleartabs(),switch_stab(d.game.lastform),d.game.paused=0,savegame()}function show_trade(){d.game.gtab_open=1,d.game.tab.open16=1,d.game.world.curr=1,switch_tab(6),cleartabs(),switch_stab(10),d.game.paused=0,savegame()}function cycle_plane(){d.game.perm.mem.lrun=[];for(var e=0;e<d.game.perm.mem.crun.length;e++)d.game.perm.mem.lrun[e]=d.game.perm.mem.crun[e];d.game.perm.mem.crun=[];var a=d.game.numcycle;a++;var l=d.game.wp,s=d.game.tree,i=d.game.perm,n=d.skill.sp.value,_=d.skill.sp.max,g=d.game.lastform,u=d.game.muted,o=d.game.volume,c=d.game.story;d=null,resetgame(),init_temp(),d.game.numcycle=a,d.game.wp=l,d.game.paused=1,d.skill.k110.unlock=0,d.game.gtab_open=0,d.game.ginfo_open=0,d.game.tree=s,d.game.perm=i,d.skill.sp.value=n,d.skill.sp.max=_,d.game.lastform=g,d.game.muted=u,d.game.volume=o,d.game.story=c,cleartabs(),show_tree()}function lose_plane(e=0){play_bgm("bgm-cycle.mp3?v=2");var a=d.game.player.lvl+1;(null==d.skill.sp.max||1e5!=d.skill.sp.max)&&(d.skill.sp.max=1e5),a+=5,a+=spn=d.game.numcycle+1,spo=0,d.game.tree.t55>0&&(a+=spo=2*d.game.tree.t55),add_sp(a);var l=stotime(round(d.game.tick/100)).replace(".0","");story.n996.text='Cycle completed in: <b style="color:#42ff60">'+l+'</b><br><br>You have gained <b class="clr-k15a">'+a+' Soul Points (SP)</b><br><i class="smaller">+5 Base Reward<br>+'+(d.game.player.lvl+1)+" Player Level(s)<br>+"+spn+" Game Cycle(s)<br>+"+spo+" Soul Sponge (2 x "+d.game.tree.t55+")</i><br><br>While everything else in the game resets, SP serves as a persistent currency used to upgrade your abilities in the <b>Skill Tree</b>. These enhancements carry over across plane cycles, empowering you to grow stronger and progress further each cycle.",show_notice(story.n996,64,1),cycle_plane()}function win_plane(){add_ds(1),d.game.perm.klg=1,lose_plane(1)}function lose_byspirit(){null!=d.game.battle&&lose_cstat(),save_lastform(),anctrack=0,hide("gbat"),losing=1,d.game.tree.t10_6>0&&0==d.game.alreadyspirited&&(d.game.alreadyspirited=1,add_ds(d.game.tree.t10_6)),show_notice(story.s108,81,1),d.game.battle=null}function lose_byblood(){null!=d.game.battle&&lose_cstat(),save_lastform(),anctrack=0,hide("gbat"),losing=1,show_notice(story.s115,81,1),d.game.battle=null}function lose_bysanity(){null!=d.game.battle&&lose_cstat(),save_lastform(),anctrack=0,hide("gbat"),losing=1,show_notice(story.s116,81,1),d.game.battle=null}function lose_cstat(){lastclog="Lost to "+skill[d.game.battle].title+"!",getcstat(d.game.battle,1),lastclog+=gencstat(),story.n997.text=lastclog,show_notice(story.n997)}function win_fight(e){defeating=0,d.skill.a999.running=0,d.skill.a999.curr=0;var a=d.skill[e].xp;if(add_xp(a),lastclog="Victory over "+skill[e].title+"!<br><br>You have gained "+a+" XP.",d.game.tree.t42>0&&"e113"==e&&(d.skill.k110.max+=.5*d.game.tree.t42),d.game.tree.t43>0&&"e1114"==e&&(d.skill.k120.max+=.5*d.game.tree.t43),d.game.tree.t10_5>0){var l=round(a/100*(d.game.tree.t10_5*(1==d.skill.k11x0418.value?3:1)));add_sp(l),lastclog+="<br>You have gained "+l+" SP (from Soul Gem)."}if(d.game.tree.t8_3>0&&d.game.stage>73){var s=5*d.game.tree.t8_3;d.skill.k110.max+=s,lastclog+="<br>You have gained "+s+" max blood (from Consume Corpse)."}if(d.game.tree.t9_1>0&&d.game.stage>73){var s=d.game.tree.t9_1;add_spirit(s),lastclog+="<br>You have gained "+s+" spirit (from Morale)."}if(d.game.tree.t7_10>0&&d.game.stage>73){var s=round(.001*a*d.game.tree.t7_10);add_ds(s),lastclog+="<br>You have gained "+s+" DS (from Soul Hunter)."}lastclog+=gencstat(),story.n997.text=lastclog,show_notice(story.n997),d.game.battle=null,lskill(e),d.skill[e].value=0,d.skill[e].curr=0,cleargm()}function save_lastform(){(d.skill.k116.unlock||d.skill.k11x0066.unlock||d.skill.k11x0046.unlock)&&(d.game.lastform=1),(d.skill.k117.unlock||d.skill.k11x0067.unlock||d.skill.k11x0047.unlock)&&(d.game.lastform=2),(d.skill.k1136.unlock||d.skill.k11x0068.unlock||d.skill.k11x0045.unlock)&&(d.game.lastform=3),(d.skill.k11616.unlock||d.skill.k11x0069.unlock)&&(d.game.lastform=4)}function add_xp(e){for(d.game.tree.t54>0&&(e+=d.game.tree.t54),d.skill.xp.curr+=e;d.skill.xp.curr>=d.skill.xp.need;)d.skill.xp.curr-=d.skill.xp.need,d.game.player.lvl++,d.game.player.nxp+=50,d.skill.xp.need=d.game.player.nxp,d.game.tree.t10_7>0&&add_ds(.1*d.game.tree.t10_7)}function minus_xp(e){d.skill.xp.curr-=e,d.skill.xp.curr<0&&(d.skill.xp.curr=0)}function add_sp(e){d.skill.sp.value+=e,d.skill.sp.value>d.skill.sp.max&&(d.skill.sp.value=d.skill.sp.max)}function can_sp(e,a=0){return 1!=d.game.stage&&62!=d.game.stage&&63!=d.game.stage&&0==a?0:d.skill.sp.value>=e?1:0}function use_sp(e){d.skill.sp.value-=e,d.skill.sp.value<0&&(d.skill.sp.value=0)}function add_ds(e){d.game.wp+=e,d.game.wp=Math.floor(100*d.game.wp)/100,d.game.wp>1e5&&(d.game.wp=1e5)}function can_ds(e){return d.game.stage<73?0:d.game.wp>=e?1:0}function use_ds(e){d.game.wp-=e,d.game.wp=Math.floor(10*d.game.wp)/10,d.game.wp<0&&(d.game.wp=0)}function bonus_ap(e){var a=0;return 1==d.skill.k115221.value&&null!=d.skill[e].ap&&(a+=1),1==d.skill.k115222.value&&null!=d.skill[e].ap&&(a+=1),1==d.skill.k115223.value&&null!=d.skill[e].ap&&(a+=1),a}function bonus_am(e){var a=0;return 1==d.skill.k115231.value&&null!=d.skill[e].am&&(a+=1),1==d.skill.k115232.value&&null!=d.skill[e].am&&(a+=1),1==d.skill.k115233.value&&null!=d.skill[e].am&&(a+=1),a}function bonus_cr(){var e=0;return 1==d.skill.k11526.unlock&&(e+=10),d.game.tree.t32>0&&(e+=d.game.tree.t32),e}function minus_blood(e){d.skill.k110.max-=e,d.skill.k110.max<0&&(d.skill.k110.max=0),d.skill.k110.value>d.skill.k110.max&&(d.skill.k110.value=d.skill.k110.max),0==d.skill.k110.max&&lose_byblood()}function minus_sanity(e){d.skill.k120.max-=e,d.skill.k120.max<0&&(d.skill.k120.max=0),d.skill.k120.value>d.skill.k120.max&&(d.skill.k120.value=d.skill.k120.max),0==d.skill.k120.max&&lose_bysanity()}function minus_spirit(e){d.skill.st.max-=e,d.skill.st.max<0&&(d.skill.st.max=0),d.skill.st.value>d.skill.st.max&&(d.skill.st.value=d.skill.st.max),0==d.skill.st.max&&lose_byspirit()}function add_spirit(e){d.skill.st.value+=e,d.skill.st.value>d.skill.st.max&&(d.skill.st.value=d.skill.st.max)}function attack(e){if(null!=d.game.battle){var a=d.skill[d.game.battle];(r=d.skill[e]).value=0,0==a.running&&(a.running=1);var l=Math.floor(100*Math.random())+1,s='<img src="img/ico-dice.png"> '+(100-l)+"% &nbsp; ";if(l<=r.acc+d.game.tree.t34){var i=d.skill[e].attack;i+=bonus_ap(e),i+=bonus_am(e);var n=5+bonus_cr();l<=n&&(i*=d.skill[e].crit);var _=0;null!=a.rp&&null!=d.skill[e].ap&&((i-=a.rp)<0&&(i=0),_=d.skill[d.game.battle].rp),null!=a.rm&&null!=d.skill[e].am&&((i-=a.rm)<0&&(i=0),_=d.skill[d.game.battle].rm),a.curr+=i,checkmax_c(d.game.battle),s+=(l<=n?"CRITICAL":"HIT")+' <b class="bigger red">'+i+"</b> "+(_>0?" (RESISTED "+_+")":""),null!=gebi("gudice-"+e)&&gebi("gudice-"+e).classList.remove("atkmiss")}else s+="MISS",null!=gebi("gudice-"+e)&&gebi("gudice-"+e).classList.add("atkmiss");null!=gebi("gudice-"+e)&&(retext("gudice-"+e,s),setTimeout("clear('gudice-"+e+"')",900)),d.skill[d.game.battle].curr>=d.skill[d.game.battle].need&&click_skill(d.game.battle)}}function eattack(e){if(null!=d.game.battle){(r=d.skill[e]).value=0;var a=r.attack,l="",s="",i=0;null!=r.ap&&(d.game.tree.t8_2>0&&(i=d.game.tree.t8_2,1==d.skill.k11x0220.value&&(i+=3),1==d.skill.k11x01191.value&&(i+=5),1==d.skill.k11x0333.value&&(i+=5),1==d.skill.k11x0324.value&&(i+=7),1==d.skill.k11x0426.value&&(i+=20)),(a-=i)<0&&(a=0),minus_blood(a),l="clr-k11a",s="Blood!"),null!=r.am&&(d.game.tree.t6_5>0&&(i=d.game.tree.t6_5,d.skill.k1245.running&&d.skill.k1245.value!=d.skill.k1245.max&&(i+=100)),(a-=i)<0&&(a=0),minus_sanity(a),l="clr-k12a",s="Sanity!"),null!=r.as&&(d.game.tree.t9_4>0&&(i=d.game.tree.t9_4),(a-=i)<0&&(a=0),minus_spirit(a),l="clr-k16a",s="Spirit!"),t=' <b class="bigger '+l+'">'+a+" "+s+"</b> "+(i>0?" (RESISTED "+i+")":""),null!=gebi("gudice-"+e)&&(retext("gudice-"+e,t),setTimeout("clear('gudice-"+e+"')",900))}}function check_cost(e){var a=d.skill[e];if(null==a.cost)return 1;for(var l=Object.keys(a.cost),s=0;s<l.length;s++)if(d.skill[l[s]].value<d.skill[e].cost[l[s]])return 0;return 1}function consume_cost(e){for(var a=Object.keys(d.skill[e].cost),l=0;l<a.length;l++){var s=d.skill[a[l]];s.value-=d.skill[e].cost[a[l]]}}function trybuy(e=""){if(1==d.game.stage||62==d.game.stage||63==d.game.stage){if(buying!=e&&hide("ttbuy-"+buying),""!=e){var a=get_stabcost(e);d.game.tree[e]<tree[e].max&&can_sp(a)?show("ttbuy-"+(buying=e)):hide("ttbuy-"+buying)}}}function performbuy(e){if(1==d.game.stage||62==d.game.stage||63==d.game.stage){var a=get_stabcost(e);can_sp(a)&&(use_sp(a),up_stab(e)),hide("ttbuy-"+e),clear("ttlvl-"+e)}}function get_stabcost(e){return null==tree[e]||null!=d.game.perm.smaxed[e]?0:(tree[e].cost+tree[e].cost*("t510"==e?1:d.game.tree[e]))*(stab==d.game.lastform||5==stab?1:2)}function up_stab(e){(1==d.game.stage||62==d.game.stage||63==d.game.stage)&&(d.game.tree[e]++,d.game.tree[e]>tree[e].max&&(d.game.tree[e]=tree[e].max),"t19"==e&&d.game.tree.t29>0&&(d.game.tree.t29=0,tree.t29.cost=0),"t29"==e&&d.game.tree.t19>0&&(d.game.tree.t19=0,tree.t19.cost=0),"t510"==e&&null!=d.game.perm.smaxed[e]&&(d.game.tree.t510+=99))}function trybuyw(e=""){if(76==d.game.stage){if(buying!=e&&hide("ttbuy-"+buying),""!=e){if("t10_2"==e){var a=get_stabcostw(e);d.game.tree[e]<tree[e].max&&can_sp(a,1)?show("ttbuy-"+(buying=e)):hide("ttbuy-"+buying)}else{var a=get_stabcostw(e);d.game.tree[e]<tree[e].max&&can_ds(a)?show("ttbuy-"+(buying=e)):hide("ttbuy-"+buying)}}}}function performbuyw(e){if(76==d.game.stage){if("t10_2"==e){var a=get_stabcostw(e);can_sp(a,1)&&(use_sp(a),up_stabw(e)),hide("ttbuy-"+e),retext("ttlvl-"+e,"")}else{var a=get_stabcostw(e);can_ds(a)&&(use_ds(a),up_stabw(e)),hide("ttbuy-"+e),retext("ttlvl-"+e,"")}}}function get_stabcostw(e){if(null==tree[e]||null!=d.game.perm.smaxed[e])return 0;var a=tree[e].cost+tree[e].cost*d.game.tree[e];return("t10_1"==e||"t10_2"==e)&&(a*=dsrate),a}function up_stabw(e){76==d.game.stage&&(d.game.tree[e]++,d.game.tree[e]>tree[e].max&&(d.game.tree[e]=tree[e].max),("t10_1"==e||"t10_2"==e)&&(d.game.tree[e]=0),"t10_1"==e&&add_sp(200*dsrate),"t10_2"==e&&add_ds(1*dsrate),"t10_3"==e&&(d.skill.st.max=60+10*d.game.tree.t10_3))}function up_atkspd(e){for(var a=Object.keys(d.skill),l=0;l<a.length;l++)"a"==a[l].substring(0,1)&&(d.skill[a[l]].need-=e,d.skill[a[l]].need<.5&&(d.skill[a[l]].need=.5))}function reset_spirit(){d.skill.st.max=60+10*d.game.tree.t10_3,d.skill.st.value=d.skill.st.max}function off_blocker(){1==d.game.tree.t57&&(d.game.tree.t57=0,tree.t57.cost=0)}function off_am(e){d.game.tree[e]>=1&&(d.game.perm.smaxed[e]=1,d.game.tree[e]=0,tree[e].cost=0)}function togmult(e){for(var a=1;a<=3;a++){var l=gebi("bsrate"+a);a==e?(l.className="multa",1==a&&(dsrate=1),2==a&&(dsrate=10),3==a&&(dsrate=100)):l.className="multb"}gebi("gutextd-t10_1").innerHTML="Gain "+200*dsrate+" SP",gebi("gutextd-t10_2").innerHTML="Gain "+1*dsrate+" DS"}function round(e){return Math.round(e)}function round1(e){return Math.round(10*e)/10}function round2(e){return Math.round(100*e)/100}function stotime(e){return t="",e>3600&&(h=Math.floor(e/3600),e-=3600*h,t+=h+"h "),e>60&&(m=Math.floor(e/60),e-=60*m,t+=m+"m "),t+=round1(e).toFixed(1)+"s"}function gebi(e){return document.getElementById(e)}function show(e){null!=gebi(e)&&""!=gebi(e).style.display&&(gebi(e).style.display="")}function hide(e){null!=gebi(e)&&"none"!=gebi(e).style.display&&(gebi(e).style.display="none")}function hide2(e){null!=gebi(e)&&"none"!=gebi(e).style.display&&$("#"+e).fadeOut()}function clear(e){null!=gebi(e)&&(gebi(e).innerHTML="")}function retext(e,a){null==gebi(e)||gebi(e).innerHTML!=a&&(gebi(e).innerHTML=a)}function cleargm(){gebi("gmain").innerHTML=""}function add_story(e){var a=0;null!=d.game.story&&(a=Object.keys(d.game.story).length),d.game.story["p"+a]=e}function load_story(){for(var e="",a=Object.keys(d.game.story),l=0;l<a.length;l++)e+="<div class='red b'>"+story[d.game.story[a[l]]].title+"</div>"+story[d.game.story[a[l]]].text+"<br><br>";gebi("gnstory").innerHTML=e}function load_attacks(){retext("divclog",lastclog);for(var e="",a=Object.keys(d.skill),l=0;l<a.length;l++){var s=a[l];if("a"==s.substring(0,1)&&"a999"!=s&&0!=d.skill[s].unlock){if(null!=d.skill[s].cost){for(var i=Object.keys(d.skill[s].cost),n="",_=0;_<i.length;_++){var g=i[_].substring(0,3),u=skill[i[_]].alt;n+='<span class="clr-'+g+'a">'+d.skill[s].cost[i[_]]+" "+u+"</span><br>"}sc=""+n}e+="<tr><td>"+skill[s].title+"</td><td class='"+("Physical"==skill[s].text?"clr-k11a":"clr-k12a")+"'>"+skill[s].text+"</td><td>"+d.skill[s].need+"s</td><td>"+sc+"</td><td>"+d.skill[s].attack+"</td><td>"+d.skill[s].acc+"</td><td>"+d.skill[s].crit+"x</td><td>"+(d.game.temp["manuala-"+s]?2==d.game.temp["manuala-"+s]?'<a id="aman'+s+'" onclick="togman(\''+s+"');\">Auto</a>":'<a id="aman'+s+'" onclick="togman(\''+s+"');\">Manual</a>":d.skill[s].auto?'<a id="aman'+s+'" onclick="togman(\''+s+"');\">Auto</a>":"Manual")+"</td></tr>"}}""!=e&&(e='<table class="tabatk smaller"><tr><th>Name</th><th>Damage<br>Type</th><th>Interval</th><th>Cost</th><th>Attack</th><th>Base<br>Accuracy</th><th>Critical<br>Rate</th><th>Toggle<br>A/M</th></tr>'+e+'</table><div class="m yellow small">(If an attack is already automated, you can toggle it to be manual)</div><br>Bonus accuracy: <span class="clr-k15a">+'+d.game.tree.t34+'%</span><br>Crit chance (base + bonus + others): 5% + <span class="clr-k15a">'+d.game.tree.t32+"% "+(d.skill.k11526.unlock?" +10%":"")+"</span>"),gebi("gnatk").innerHTML=e}function togman(e){var a=gebi("aman"+e);1==d.game.temp["manuala-"+e]?(d.game.temp["manuala-"+e]=2,a.innerHTML="Auto"):(d.game.temp["manuala-"+e]=1,a.innerHTML="Manual")}function load_log(){for(var e="",a=Object.keys(logs),l=0;l<a.length;l++)e+="<b><u>"+a[l]+"</u></b><br>"+logs[a[l]].text+"<br>";gebi("gnlog").innerHTML=e}function show_notice(e,a=0,l=0){(last_story!=e||"CLOUD SAVE"==e.title)&&(last_story=e,d.game.tree.t57>0&&0==l&&d.game.stage<62||d.game.tree.t7_5>0&&1==anctrack&&d.game.stage>=70&&0==l?(a>-1&&(d.game.next_stage=a),d.game.paused=0):(d.game.paused=1,a>-1&&(d.game.next_stage=a),gebi("gnbtn").value="继续",gebi("gntitle").innerHTML=e.title,gebi("gntext").innerHTML=e.text,gebi("visual").src=null==e.img||!0==gebi("noimg").checked?"":"img/"+e.img,show("gnoverlay"),show("gnotice"),window.scrollTo(0,0)))}function close_notice(){0!=d.game.next_stage&&stage_check(),d.game.paused=0,hide("gnotice"),hide("gnoverlay"),window.scrollTo(0,0),gebi("visual").src="",d.game.paused=0}function cleartabs(){gebi("ginfo").innerHTML="",gebi("gtab").innerHTML="",cleargm(),changed_tab=1}function resetgame(){resetting=1,d=null,localStorage.setItem(storage_marker,null),loadgame();for(var e=Object.keys(d.skill),a=0;a<e.length;a++)d.skill[e[a]].value=0;cleartabs()}function resetcycle(){var e=d.game.numcycle,a=d.game.wp,l=d.game.tree,s=d.game.perm,i=d.skill.sp.value,n=d.skill.sp.max,_=d.game.lastform,g=d.game.muted,u=d.game.volume;d=null,resetgame(),init_temp(),d.game.numcycle=e,d.game.wp=a,d.game.tree=l,d.game.perm=s,init_temp(),d.skill.sp.value=i,d.skill.sp.max=n,d.game.lastform=_,d.game.muted=g,d.game.volume=u,d.game.tab.open15=1,apply_tree(),hide("gmisc2"),hide("gnoverlay"),d.game.paused=0}function exportgame(){savegame();var e=localStorage.getItem(storage_marker);!0==gebi("exptxt").checked?(show("txta"),gebi("txta").innerHTML=e):(navigator.clipboard.writeText(e),gebi("imexinfo").innerHTML="Exported to clipboard.")}function importgame(e){var a=null;if(!0==gebi("impclip").checked)null==e?getclip():a=e;else if(!0==gebi("imptxt").checked)a=gebi("txta").value;else var a=prompt("Paste your game data:");null!=a&&""!=a&&(localStorage.setItem(storage_marker,a),loadgame(),hide("gmisc2"),hide("gnoverlay"),d.game.paused=0)}function getclip(){navigator.clipboard.readText().then(e=>{importgame(z=e)}).catch(e=>{})}function savegame(){localStorage.setItem(storage_marker,btoa(JSON.stringify(d)))}function loadgame(){var e=localStorage.getItem(storage_marker);if(0==isjson(e)||null==e||"null"==e)try{e=atob(e)}catch(a){e=null}0==isjson(e)||null==e||"null"==e?init_d():(d=JSON.parse(e),init_s(),init_k()),null!=d.game.perm.noart&&(gebi("noimg").checked=1==d.game.perm.noart),cleartabs(),d.game.paused=0}function startgame(){loadgame(),0==nosplash?(d.game.paused=1,splash()):hide("splash"),switch_tab(d.game.tab["curr"+d.game.world.curr]),0==loop_inited&&(loop_inited=1,gameloop(),update_ui(),update_ui_delay()),gebi("imute").src="img/ico-v"+(1==d.game.muted?0:1)+".png"}function splash(){setTimeout(function(){$("#splash").css("background","#000000")},1e3),$("#splash").bind("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd",function(){setTimeout(function(){$("#splash").fadeOut(1e3,"swing",function(){d.game.paused=0})},1e3)})}function isjson(e){try{JSON.parse(e)}catch(a){return 0}return 1}function init_s(){for(var e=init_d(1),a=Object.keys(e.skill),l=0;l<a.length;l++)null==d.skill[a[l]]&&(d.skill[a[l]]=e.skill[a[l]])}function init_k(){for(var e=1;e<=10;e++)for(var a=1;a<=19;a++){var l="";e>5&&(l="_"),null==d.game.tree["t"+e+l+a]&&(d.game.tree["t"+e+l+a]=0)}null==d.game.wp&&(d.game.wp=0),null==d.game.numcycle&&(d.game.numcycle=0),null==d.game.temp&&init_temp(),null==d.game.perm&&(d.game.perm={}),null==d.game.perm.smaxed&&(d.game.perm.smaxed={}),null==d.game.perm.mem&&(d.game.perm.mem={}),null==d.game.perm.mem.lrun&&(d.game.perm.mem.lrun={}),null==d.game.perm.mem.crun&&(d.game.perm.mem.crun={}),null==d.game.perm.trade&&(d.game.perm.trade=0),null==d.game.perm.klg&&(d.game.perm.klg=0),null==d.game.perm.kjz&&(d.game.perm.kjz=0),null==d.game.perm.kbenc&&(d.game.perm.kbenc=0),null==d.game.perm.manap&&(d.game.perm.manap=0),null==d.game.perm.rubyp&&(d.game.perm.rubyp=0),null==d.game.perm.snekc&&(d.game.perm.snekc=0),null==d.game.perm.ktrea&&(d.game.perm.ktrea=0),null==d.game.perm.sfuse&&(d.game.perm.sfuse=0),null==d.game.perm.hourg&&(d.game.perm.hourg=0),null==d.game.perm.e1138&&(d.game.perm.e1138=0),null==d.game.perm.e1139&&(d.game.perm.e1139=0),null==d.game.perm.e1140&&(d.game.perm.e1140=0),null==d.game.perm.e1141&&(d.game.perm.e1141=0),null==d.game.perm.e1142&&(d.game.perm.e1142=0),null==d.game.perm.e1143&&(d.game.perm.e1143=0),null==d.game.perm.e1144&&(d.game.perm.e1144=0),null==d.game.perm.e1145&&(d.game.perm.e1145=0),null==d.game.perm.e1146&&(d.game.perm.e1146=0),null==d.game.perm.e1147&&(d.game.perm.e1147=0),null==d.game.perm.e1148&&(d.game.perm.e1148=0),null==d.game.perm.noart&&(d.game.perm.noart=0),null==d.game.tab.open16&&(d.game.tab.open16=0),null==d.game.perm.t6open&&(d.game.perm.t6open=0),null==d.game.perm.t7open&&(d.game.perm.t7open=0),null==d.game.perm.t8open&&(d.game.perm.t8open=0),null==d.game.perm.t9open&&(d.game.perm.t9open=0),null==d.game.perm.t10open&&(d.game.perm.t10open=1)}function init_temp(){d.game.temp={kwitch:0,freea:0,kchamp:0,ksnap:0,aprot:0,mprot:0,sprot:0,fork1:0,fork2:0,fork3:0,fork4:0,cursemp:0,retrace:0,reanim:0,rescbat:0,rescwolf:0,rescgoblin:0,merch:0}}var bgm=null;function first_tap(){1!=interacted&&(interacted=1,d.game.stage<73?play_bgm("bgm.mp3"):d.game.stage<78?play_bgm("bgm2-prologue.mp3"):d.game.stage<200&&play_bgm("bgm2.mp3"))}function play_bgm(e){if(0==d.game.muted){if(null!=bgm){try{bgm.pause()}catch(a){}bgm.currentTime=0}if((bgm=new Audio("sound/"+e)).loop=!0,bgm.addEventListener("ended",function(){this.currentTime=0;try{this.play()}catch(e){interacted=0}},!1),gebi("svolume").value=d.game.volume,toggle_volume(d.game.muted),do_volume(d.game.volume),0==d.game.muted&&1==interacted)try{bgm.play()}catch(l){interacted=0}}}function do_volume(e){bgm.volume=e/100,d.game.volume=e}function toggle_volume(e=-1){if(e>-1?d.game.muted=e:d.game.muted=1==d.game.muted?0:1,1==(v=d.game.muted)){try{bgm.pause()}catch(a){}gebi("imute").src="img/ico-v0.png"}else{if(1==interacted)try{bgm.play()}catch(l){play_bgm("bgm.mp3")}gebi("imute").src="img/ico-v1.png"}}function toggle_pause(){1==d.game.paused?(d.game.paused=0,gebi("ipause").src="img/ico-p1.png",$("#gpause").fadeOut(200,"swing")):(d.game.paused=1,gebi("ipause").src="img/ico-p0.png",$("#gpause").fadeIn(200,"swing"))}function togart(){d.game.perm.noart=!0==gebi("noimg").checked?1:0}function cloudsave(){savegame();var e=localStorage.getItem(storage_marker);e=e.replaceAll(/=/g,"-");var a=new XMLHttpRequest;if(null==a){alert("Your browser does not support cloud save.");return}a.open("POST",cloud_url,!0),a.setRequestHeader("Content-type","application/x-www-form-urlencoded"),a.onreadystatechange=function(){4==a.readyState&&200==a.status&&cloudsaveres(a)},a.send("mode=save&data="+e)}function cloudsaveres(e){4==e.readyState&&(hide("gmisc2"),hide("gnoverlay"),8==(cscode=e.responseText).length?(story.n995.text='Cloud save successful.<br>Copy code below to use when restoring backup from cloud.<br><span style="color:#999; font-size:80%;">(Cloud save codes are valid for 90 days)</span><br><br><input id="txtcscode" class="txtcscode" type="text" value="'+cscode+'">',show_notice(story.n995,-1,1),gebi("txtcscode").focus()):(story.n995.text="There is error is uploading your save data.<br><br>Please try again later.",show_notice(story.n995,-1,1)))}function cloudload(){var e=prompt("Paste your Cloud Save code:");if(null!=e&&""!=e&&8==e.length){var a=new XMLHttpRequest;if(null==a){alert("Your browser does not support cloud save.");return}a.open("POST",cloud_url,!0),a.setRequestHeader("Content-type","application/x-www-form-urlencoded"),a.onreadystatechange=function(){4==a.readyState&&200==a.status&&cloudloadres(a)},a.send("mode=load&code="+e)}}function cloudloadres(e){if(4==e.readyState){var a=e.responseText;a=a.replaceAll(/\-/g,"="),localStorage.setItem(storage_marker,a),loadgame(),hide("gmisc2"),hide("gnoverlay"),d.game.paused=0}}function keyin(){var e=gebi("key").value;e=e.toLowerCase(),gebi("key").value=""," "==e&&toggle_pause(),"m"==e&&toggle_volume(),"c"==e&&"none"!=gebi("gnotice").style.display&&null==gebi("txtcscode")&&close_notice(),"c"==e&&"none"!=gebi("gmisc").style.display&&gebi("gnbtn1").click(),"c"==e&&"none"!=gebi("gmisc2").style.display&&gebi("gnbtn2").click(),"c"==e&&"none"!=gebi("gmisc3").style.display&&gebi("gnbtn3").click(),"c"==e&&"none"!=gebi("gmisc4").style.display&&gebi("gnbtn4").click(),"c"==e&&"none"!=gebi("gmisc5").style.display&&gebi("gnbtn5").click(),"b"==e&&"none"!=gebi("newcycle").style.display&&apply_tree(),"q"==e&&null!=gebi("gtab11")&&switch_tab(1),"w"==e&&null!=gebi("gtab12")&&switch_tab(2),"e"==e&&null!=gebi("gtab15")&&switch_tab(5),"r"==e&&null!=gebi("gtab16")&&switch_tab(6),"k"==e&&gebi("iclog").click(),"l"==e&&gebi("islog").click(),"s"==e&&gebi("isett").click(),"a"==e&&gebi("ilove").click(),"d"==e&&gebi("idlog").click()}function bkey(e){var a=keyh[e.which];""!=a&&(gebi("key").value=a,keyin())," "==a&&e.preventDefault()}